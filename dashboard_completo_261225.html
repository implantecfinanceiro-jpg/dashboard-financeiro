<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* ========== ESTILOS GERAIS ========== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        
        /* ========== TELA DE APRESENTA√á√ÉO CORRIGIDA ========== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }
        
        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
        
        .splash-logo {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
            text-align: center;
            text-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            position: relative;
            top: -50px;
            animation: fadeInDown 1s ease-out forwards;
        }
        
        .splash-subtitle {
            font-size: 1.5rem;
            color: #94a3b8;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 3rem;
            max-width: 800px;
            position: relative;
            top: -30px;
            animation: fadeIn 1.2s ease-out 0.3s both;
        }
        
        .splash-button {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
            position: relative;
            top: -10px;
            animation: fadeInUp 1s ease-out 0.6s both;
        }
        
        .splash-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(37, 99, 235, 0.4);
            background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ========== DASHBOARD PRINCIPAL ========== */
        .dashboard-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .dashboard-content.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* ========== MODAIS ========== */
        .modal-detalhes-parcela, .modal-editar-status {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .modal-detalhes-parcela.active, .modal-editar-status.active {
            display: flex;
        }
        
        .modal-conteudo, .modal-editar-conteudo {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #3b82f6;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-editar-conteudo {
            max-width: 600px;
        }
        
        .modal-header, .modal-editar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #374151;
        }
        
        .modal-titulo, .modal-editar-titulo {
            color: #60a5fa;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .btn-fechar-modal {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .btn-fechar-modal:hover {
            background: #4b5563;
        }
        
        /* ========== LAYOUT DAS PARCELAS MONITORADAS CORRIGIDO ========== */
        .parcelas-monitoradas-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.3);
            margin-bottom: 1rem;
        }
        
        .parcela-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .parcela-item:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .parcela-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .parcela-cliente {
            font-weight: 700;
            color: #e5e7eb;
            font-size: 1rem;
        }
        
        .parcela-probabilidade {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .parcela-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .detalhe-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .detalhe-label {
            color: #94a3b8;
        }
        
        .detalhe-valor {
            color: #e5e7eb;
            font-weight: 600;
        }
        
        /* Classes de probabilidade */
        .alta-probabilidade .parcela-probabilidade {
            background-color: #ef4444;
            color: white;
        }
        
        .media-probabilidade .parcela-probabilidade {
            background-color: #f59e0b;
            color: white;
        }
        
        .baixa-probabilidade .parcela-probabilidade {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Classes de status */
        .pago-atraso {
            border-left: 4px solid #ef4444;
        }
        
        .dentro-prazo {
            border-left: 4px solid #10b981;
        }
        
        /* ========== FILTROS CLIC√ÅVEIS COM SELE√á√ÉO M√öLTIPLA ========== */
        .filtros-container {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .filtros-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .filter-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background: #4b5563;
            color: #d1d5db;
            border: 2px solid transparent;
        }
        
        .filter-badge:hover {
            background: #6b7280;
            transform: translateY(-1px);
        }
        
        .filter-badge.active {
            background: #3b82f6;
            color: white;
            border-color: #60a5fa;
        }
        
        .filter-badge.selected {
            background: #10b981;
            color: white;
            border-color: #34d399;
        }
        
        .filter-badge.multiple-select {
            background: #8b5cf6;
            color: white;
            border-color: #a78bfa;
        }
        
        .filtros-multiplos-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }
        
        .filtros-multiplos-info.active {
            display: block;
        }
        
        .btn-limpar-filtros, .btn-limpar-filtros-multiplos {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .btn-limpar-filtros:hover, .btn-limpar-filtros-multiplos:hover {
            background: #4b5563;
        }
        
        /* ========== BARRAS DE ROLAGEM RESTAURADAS ========== */
        .overflow-auto, .overflow-x-auto, .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        
        .overflow-auto::-webkit-scrollbar,
        .overflow-x-auto::-webkit-scrollbar,
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .overflow-auto::-webkit-scrollbar-track,
        .overflow-x-auto::-webkit-scrollbar-track,
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }
        
        .overflow-auto::-webkit-scrollbar-thumb,
        .overflow-x-auto::-webkit-scrollbar-thumb,
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        
        .overflow-auto::-webkit-scrollbar-thumb:hover,
        .overflow-x-auto::-webkit-scrollbar-thumb:hover,
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* ========== CAIXA DE SELE√á√ÉO EM PLANILHAS CORRIGIDA ========== */
        .config-section {
            margin-bottom: 1.5rem;
        }
        
        .config-label {
            display: block;
            color: #e5e7eb;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .config-select, .config-input {
            width: 100%;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 0.75rem;
            color: #e5e7eb;
            font-size: 0.9rem;
        }
        
        .config-select:focus, .config-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .config-select option {
            background: #1f2937;
            color: #e5e7eb;
            padding: 0.5rem;
        }
        
        /* √Årea de upload */
        .upload-area {
            border: 2px dashed #4b5563;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(30, 41, 59, 0.3);
            margin-bottom: 1.5rem;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .file-list {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #374151;
        }
        
        /* ========== EDI√á√ÉO DE STATUS ========== */
        .btn-editar-status {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .btn-editar-status:hover {
            background: #4b5563;
        }
        
        .opcoes-status {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .opcao-status {
            padding: 1rem;
            border: 2px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .opcao-status:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .opcao-status.selecionada {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        
        .icone-status {
            font-size: 1.5rem;
        }
        
        .texto-status {
            flex: 1;
        }
        
        .titulo-status {
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .descricao-status {
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        /* ========== TOGGLE "MOSTRAR APENAS ATRASADOS" ========== */
        .toggle-atrasados {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            border: 1px solid #374151;
        }
        
        .toggle-atrasados label {
            flex: 1;
            font-weight: 600;
            color: #d1d5db;
            font-size: 0.875rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* ========== EXPORTA√á√ÉO PARA RECUPERA√á√ÉO ========== */
        .exportar-recuperacao-container {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .exportar-recuperacao-botoes {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .btn-exportar-recuperacao {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            flex: 1;
        }
        
        .btn-exportar-recuperacao:hover {
            background: #2563eb;
        }
        
        .btn-exportar-recuperacao.cancelar {
            background: #6b7280;
        }
        
        .btn-exportar-recuperacao.cancelar:hover {
            background: #4b5563;
        }
        
        /* ========== ESTILO PARA PAGAMENTOS FORA DO M√äS ========== */
        .fora-do-mes {
            color: #f59e0b !important;
            font-weight: 600 !important;
        }
        
        .fora-do-mes::before {
            content: "‚ö†Ô∏è ";
        }
        
        /* ========== TABELA DE PAGAMENTOS ========== */
        .payment-table-container {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .payment-table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #3b82f6;
        }
        
        .payment-category-row:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .payment-total-row {
            background: rgba(30, 41, 59, 0.5);
            font-weight: 700;
        }
        
        /* ========== INFO BOX ========== */
        .info-box {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .info-box.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #94a3b8;
        }
        
        .close-btn:hover {
            color: #e5e7eb;
        }
        
        #info-content {
            font-size: 0.875rem;
            line-height: 1.6;
            color: #d1d5db;
        }
        
        /* ========== FERRAMENTAS DE C√ìPIA ========== */
        .copy-tools {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .copy-tools.active {
            display: block;
            animation: slideInLeft 0.3s ease;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .copy-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        
        .copy-btn:hover {
            background: #2563eb;
        }
        
        /* ========== DIFEREN√áAS DE DIAS ========== */
        .diferenca-negativa {
            color: #ef4444 !important;
        }
        
        .diferenca-positiva {
            color: #10b981 !important;
        }
        
        /* ========== MODAL INTERPRETA√á√ÉO ========== */
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .modal-item {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .modal-label {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .modal-valor {
            color: #e5e7eb;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .modal-interpretacao {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .modal-interpretacao-titulo {
            color: #60a5fa;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }
        
        .modal-interpretacao-texto {
            color: #d1d5db;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* ========== WIDGETS ========== */
        .highlighted-widget {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3) !important;
            border-color: #3b82f6 !important;
            z-index: 10;
            position: relative;
        }
        
        .non-highlighted {
            opacity: 0.7;
            filter: blur(1px);
        }
        
        /* ========== NOVOS ESTILOS PARA PARCELAS ATRASADAS ========== */
        .filter-badge-atrasado {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background: #4b5563;
            color: #d1d5db;
            border: 2px solid transparent;
        }
        
        .filter-badge-atrasado:hover {
            background: #6b7280;
            transform: translateY(-1px);
        }
        
        .filter-badge-atrasado.active {
            background: #ef4444;
            color: white;
            border-color: #f87171;
        }
        
        .parcelas-atrasadas-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.3);
            margin-bottom: 1rem;
        }
        
        /* ========== ESTILOS PARA WIDGETS MAXIMIZADOS ========== */
        .maximized {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1000 !important;
            margin: 0 !important;
        }
        
        .close-maximize-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 1001;
            transition: all 0.2s;
        }
        
        .close-maximize-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <!-- Tela de Apresenta√ß√£o CORRIGIDA -->
    <div id="splashScreen" class="splash-screen">
        <h1 class="splash-logo">DASHBOARD FINANCEIRO</h1>
        <p class="splash-subtitle">Dashboard Financeiro Completo<br>An√°lise de Inadimpl√™ncia, Recupera√ß√£o e Cr√©dito<br>Per√≠odo: 2025</p>
        <button class="splash-button" onclick="enterDashboard()">Acessar Dashboard</button>
    </div>

    <!-- Modal para Detalhes da Parcela -->
    <div id="modalDetalhesParcela" class="modal-detalhes-parcela">
        <div class="modal-conteudo">
            <div class="modal-header">
                <h3 class="modal-titulo">üìã Detalhes da Parcela</h3>
                <button class="btn-fechar-modal" onclick="fecharModalDetalhes()">Fechar</button>
            </div>
            
            <div class="modal-grid" id="modalDetalhesConteudo">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            
            <div class="modal-interpretacao" id="modalInterpretacao">
                <!-- Interpreta√ß√£o ser√° preenchida dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para Edi√ß√£o de Status -->
    <div id="modalEditarStatus" class="modal-editar-status">
        <div class="modal-editar-conteudo">
            <div class="modal-editar-header">
                <h3 class="modal-editar-titulo">‚úèÔ∏è Editar Status da Parcela</h3>
                <button class="btn-fechar-modal" onclick="fecharModalEditarStatus()">Fechar</button>
            </div>
            
            <div id="editarStatusInfo">
                <!-- Informa√ß√µes da parcela ser√£o preenchidas aqui -->
            </div>
            
            <div class="opcoes-status" id="opcoesStatus">
                <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
            </div>
            
            <div class="flex justify-between">
                <button class="btn-exportar-recuperacao cancelar" onclick="fecharModalEditarStatus()">Cancelar</button>
                <button class="btn-exportar-recuperacao" onclick="salvarStatusParcela()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboardMain" class="dashboard-content flex h-screen" onclick="unhighlightWidget(event)">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col">
            <div class="p-4 text-2xl font-bold">Dashboard</div>
            <nav class="flex-1">
                <ul class="space-y-2 p-4">
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('inicio')">üè† In√≠cio</a></li>
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('inadimplencia')">‚ö†Ô∏è Inadimpl√™ncia</a></li>
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('recuperacao')">üí∞ Recupera√ß√£o</a></li>
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('credtime')">üìà Cr√©ditime</a></li>
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('planilhas')">üìä Planilhas</a></li>
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</a></li>
                    <li><a href="#" class="block p-2 hover:bg-blue-600 hover:text-white rounded transition duration-300" onclick="showSection('renegociar')">üîÑ Renegociar</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-gray-900 shadow p-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-300 inline-block">An√°lise Financeira: 2025</h1>
                    <span id="company-name" contenteditable="true" class="text-3xl font-extrabold text-white ml-2" onblur="saveCompanyName()">Implantec</span>
                </div>
                <div class="flex items-center space-x-4">
                    <input type="text" id="search-input" placeholder="Pesquisar..." class="border rounded p-2 text-black">
                    <button onclick="searchDashboard()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">Pesquisar</button>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="p-6 flex-1 overflow-auto">
                <!-- Se√ß√£o In√≠cio (VIS√çVEL POR PADR√ÉO) -->
                <div id="main-section-inicio" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Widget de Inadimpl√™ncia (Highlights) -->
                    <div id="widget-inadimplencia-highlight" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-inadimplencia-highlight')">Inadimpl√™ncia Atual - Comparativo</h2>
                        <canvas id="inadimplenciaChartHighlight"></canvas>
                    </div>

                    <!-- Widget de Recupera√ß√£o (Highlights) -->
                    <div id="widget-recuperacao-highlight" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-recuperacao-highlight')">√çndice de Cr√©dito Recuperado (%)</h2>
                        <canvas id="recuperacaoChartHighlight"></canvas>
                    </div>

                    <!-- Widget de Cr√©ditime (Highlights) -->
                    <div id="widget-credtime-highlight" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-credtime-highlight')">An√°lise de Cr√©dito</h2>
                        <canvas id="credtimeChartHighlight"></canvas>
                    </div>

                    <!-- Widget de Varia√ß√£o (Highlights) -->
                    <div id="widget-variacao-highlight" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">Varia√ß√£o entre m√™s atual e anterior</h2>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold cursor-pointer" id="recuperacao-variacao-highlight-text" onclick="showInfoBox('recuperacao')">üí∞ <span id="recuperacao-variacao-highlight">0,00</span>%</p>
                                <p class="text-gray-400">Recupera√ß√£o</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold cursor-pointer" id="inadimplencia-variacao-highlight-text" onclick="showInfoBox('inadimplencia')">‚ö†Ô∏è <span id="inadimplencia-variacao-highlight">0,00</span>%</p>
                                <p class="text-gray-400">Inadimpl√™ncia</p>
                            </div>
                        </div>
                    </div>

                    <!-- Widget de Notas e Parceiros (Highlights) - ATUALIZADO -->
                    <div id="widget-notas-parceiros-highlight" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-notas-parceiros-highlight')">Notas e Parceiros</h2>
                        <canvas id="notasParceirosChartHighlight"></canvas>
                    </div>

                    <!-- Widget de Estat√≠sticas de Cobran√ßa ATUALIZADO -->
                    <div id="widget-estatisticas-cobranca-highlight" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">Estat√≠sticas de Cobran√ßa</h2>
                        <div class="h-48 overflow-y-auto">
                            <table class="w-full text-left text-sm" id="estatisticas-cobranca-table">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-1">Categoria</th>
                                        <th class="p-1 text-right">Quantidade</th>
                                        <th class="p-1 text-right">Valor</th>
                                        <th class="p-1 text-right">%</th>
                                    </tr>
                                </thead>
                                <tbody id="estatisticas-cobranca-body">
                                    <!-- Dados ser√£o carregados automaticamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Inadimpl√™ncia -->
                <div id="main-section-inadimplencia" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Widget 2: Gr√°fico de Inadimpl√™ncia Atual - Comparativo -->
                    <div id="widget-inadimplencia-2" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-inadimplencia-2')">Inadimpl√™ncia Atual - Comparativo</h2>
                        <canvas id="inadimplenciaChartInad"></canvas>
                    </div>

                    <!-- Widget 7: Gr√°fico de Notas e Parceiros -->
                    <div id="widget-notas-parceiros" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-notas-parceiros')">Notas e Parceiros</h2>
                        <canvas id="notasParceirosChartInad"></canvas>
                    </div>

                    <!-- Widget 8: Gr√°fico de Atrasos por Ano -->
                    <div id="widget-atrasos-ano" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-atrasos-ano')">Atrasos por Ano</h2>
                        <canvas id="atrasosAnoChartInad"></canvas>
                    </div>

                    <!-- Widget 9: Gr√°fico de Distribui√ß√£o de Valores de Cobran√ßa -->
                    <div id="widget-cobranca-pie" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-cobranca-pie')">Distribui√ß√£o de Valores de Cobran√ßa</h2>
                        <canvas id="cobrancaPieChartInad"></canvas>
                    </div>

                    <!-- Widget 5: Gr√°fico de Valor L√≠quido da Inadimpl√™ncia -->
                    <div id="widget-valor-inadimplencia-2" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-valor-inadimplencia-2')">Valor L√≠quido da Inadimpl√™ncia</h2>
                        <canvas id="valorInadimplenciaChartInad"></canvas>
                    </div>

                    <!-- NOVO WIDGET: Parcelas em Atraso -->
                    <div id="widget-parcelas-atrasadas" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300 col-span-3">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Parcelas em Atraso</h2>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-red-600 text-white px-2 py-1 rounded-full" id="total-parcelas-atrasadas">0</span>
                                <button class="btn-limpar-filtros text-xs" onclick="limparFiltrosAtrasados()" title="Limpar todos os filtros">
                                    üóëÔ∏è Limpar filtros
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filtros por Status de Cobran√ßa -->
                        <div class="filtros-container mb-4">
                            <div class="filtros-header">
                                <div class="text-sm text-gray-400">Filtrar por Status de Cobran√ßa:</div>
                                <button onclick="limparFiltrosAtrasados()" class="btn-limpar-filtros" title="Limpar todos os filtros">
                                    üóëÔ∏è Limpar filtros
                                </button>
                            </div>
                            
                            <div class="flex flex-wrap gap-1">
                                <span class="filter-badge-atrasado active" data-filtro="todos" onclick="alternarFiltroAtrasado('todos')">Todos</span>
                                <span class="filter-badge-atrasado" data-filtro="notificados" onclick="alternarFiltroAtrasado('notificados')">NOTIFICADOS</span>
                                <span class="filter-badge-atrasado" data-filtro="ajuizados" onclick="alternarFiltroAtrasado('ajuizados')">AJUIZADOS</span>
                                <span class="filter-badge-atrasado" data-filtro="acordo-judicial" onclick="alternarFiltroAtrasado('acordo-judicial')">ACORDO - CLIENTE REC. JUDICIAL</span>
                                <span class="filter-badge-atrasado" data-filtro="acordos-assinados" onclick="alternarFiltroAtrasado('acordos-assinados')">ACORDOS ASSINADOS</span>
                                <span class="filter-badge-atrasado" data-filtro="parceiros-estrategicos" onclick="alternarFiltroAtrasado('parceiros-estrategicos')">PARCEIROS (ESTRAT√âGICOS)</span>
                                <span class="filter-badge-atrasado" data-filtro="prescritos" onclick="alternarFiltroAtrasado('prescritos')">PREESCRITOS</span>
                                <span class="filter-badge-atrasado" data-filtro="valor-inferior" onclick="alternarFiltroAtrasado('valor-inferior')">VALOR INFERIOR</span>
                                <span class="filter-badge-atrasado" data-filtro="negociacao-andamento" onclick="alternarFiltroAtrasado('negociacao-andamento')">NEGOCIA√á√ÉO EM ANDAMENTO</span>
                                <span class="filter-badge-atrasado" data-filtro="a-negociar" onclick="alternarFiltroAtrasado('a-negociar')">√Ä NEGOCIAR</span>
                            </div>
                        </div>
                        
                        <!-- Lista de Parcelas -->
                        <div class="parcelas-atrasadas-container" id="lista-parcelas-atrasadas">
                            <p class="text-gray-400 text-center p-4">Nenhuma parcela em atraso encontrada. Processe uma planilha na se√ß√£o Planilhas.</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Configura√ß√µes -->
                <div id="configuracoes-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Card 1: √çndice de Inadimpl√™ncia -->
                    <div id="inadimplencia-table" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">√çndice de Inadimpl√™ncia</h2>
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">M√™s</th>
                                        <th class="p-2">Total Atrasado</th>
                                        <th class="p-2">Total Contas a Receber</th>
                                        <th class="p-2">√çndice (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Abril/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">1.743.418,76</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">19.381.613,15</td>
                                        <td class="p-2 index-cell">9,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Maio/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">1.771.124,48</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">19.967.603,90</td>
                                        <td class="p-2 index-cell">8,87%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Junho/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">1.912.027,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">16.000.000,00</td>
                                        <td class="p-2 index-cell">11,95%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Julho/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">1.850.000,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">17.500.000,00</td>
                                        <td class="p-2 index-cell">10,57%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Agosto/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Setembro/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Outubro/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Novembro/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Dezembro/25</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-inadimplencia" onblur="handleManualEdit(this); updateInadimplenciaCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card 2: √çndice de Recupera√ß√£o -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">√çndice de Recupera√ß√£o</h2>
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">M√™s</th>
                                        <th class="p-2">Valor Recuperado</th>
                                        <th class="p-2">Total Atrasado</th>
                                        <th class="p-2">√çndice (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Abril/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">680.351,33</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">2.423.770,09</td>
                                        <td class="p-2 index-cell">28,07%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Maio/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">302.733,59</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">2.073.858,07</td>
                                        <td class="p-2 index-cell">14,60%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Junho/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">150.000,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">2.062.027,00</td>
                                        <td class="p-2 index-cell">7,27%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Julho/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">320.000,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">1.850.000,00</td>
                                        <td class="p-2 index-cell">17,30%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Agosto/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Setembro/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Outubro/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Novembro/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Dezembro/25</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage(); updateVariationValues();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-recuperacao" onblur="handleManualEdit(this); updateRecuperacaoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td class="p-2 index-cell">0,00%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card 3: An√°lise de Cr√©dito -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">An√°lise de Cr√©dito</h2>
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">M√™s</th>
                                        <th class="p-2">M√©dia An√°lises/Dia</th>
                                        <th class="p-2">Total An√°lises</th>
                                        <th class="p-2">Prazo M√©dio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Abril/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">12,09</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">254</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">1h12min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Maio/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">14,19</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">298</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">1h24min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Junho/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">13,45</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">269</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">1h18min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Julho/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">15,32</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">322</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">1h15min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Agosto/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">0h00min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Setembro/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">0h00min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Outubro/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">0h00min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Novembro/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">0h00min</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">Dezembro/25</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0,00</td>
                                        <td contenteditable="true" class="p-2 update-analise-credito" onblur="handleManualEdit(this); updateAnaliseCreditoCharts(); saveDataToLocalStorage();">0</td>
                                        <td contenteditable="true" class="p-2 update-prazo-medio" onblur="handleManualEdit(this); updatePrazoMedioChart(); saveDataToLocalStorage();">0h00min</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card 4: √çndices Hist√≥ricos (EDIT√ÅVEL) - ATUALIZADO -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">√çndices Hist√≥ricos (Atrasados)</h2>
                        <div class="overflow-x-auto">
                            <table id="historico-table" class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">Ano</th>
                                        <th class="p-2">Valor Atrasado</th>
                                        <th class="p-2">Total Contas</th>
                                        <th class="p-2">√çndice (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">2024</td>
                                        <td contenteditable="true" class="p-2 update-historico" onblur="handleManualEdit(this); updateHistoricoIndices(); saveDataToLocalStorage();">507.461,98</td>
                                        <td contenteditable="true" class="p-2 update-historico" onblur="handleManualEdit(this); updateHistoricoIndices(); saveDataToLocalStorage();">63.625.030,17</td>
                                        <td class="p-2 index-cell-historico">0,80%</td>
                                    </tr>
                                    <tr class="border-t border-gray-600">
                                        <td class="p-2">2025</td>
                                        <td contenteditable="true" class="p-2 update-historico" onblur="handleManualEdit(this); updateHistoricoIndices(); saveDataToLocalStorage();">88.408,75</td>
                                        <td contenteditable="true" class="p-2 update-historico" onblur="handleManualEdit(this); updateHistoricoIndices(); saveDataToLocalStorage();">19.713.366,86</td>
                                        <td class="p-2 index-cell-historico">0,45%</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="mt-2 text-xs text-gray-400">
                                <p>üí° Dados carregados automaticamente da planilha de atrasados (Data de Emiss√£o)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Card 5: Estat√≠sticas de Cobran√ßa ATUALIZADO -->
                    <div id="cobranca-table" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">Estat√≠sticas de Cobran√ßa</h2>
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">Categoria Cobran√ßa</th>
                                        <th class="p-2">Quantidade</th>
                                        <th class="p-2">Valor</th>
                                        <th class="p-2">% do Total</th>
                                    </tr>
                                </thead>
                                <tbody id="cobranca-table-body">
                                    <!-- Conte√∫do ser√° carregado automaticamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card 6: Notas e Parceiros ATUALIZADO -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">Notas e Parceiros</h2>
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">M√™s</th>
                                        <th class="p-2">Notas em Aberto</th>
                                        <th class="p-2">Parceiros</th>
                                    </tr>
                                </thead>
                                <tbody id="notas-parceiros-table-body">
                                    <!-- Conte√∫do ser√° carregado automaticamente -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            <p>üí° Dados carregados automaticamente da planilha de atrasados (desconsiderando duplicados)</p>
                        </div>
                    </div>

                    <!-- Card 7: Atrasos por Ano ATUALIZADO -->
                    <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">Atrasos por Ano</h2>
                        <div class="overflow-x-auto h-80">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="p-2">Ano</th>
                                        <th class="p-2">Valor Total em Atraso</th>
                                        <th class="p-2">Quantidade</th>
                                    </tr>
                                </thead>
                                <tbody id="atrasos-ano-table-body">
                                    <!-- Conte√∫do ser√° carregado automaticamente -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            <p>üí° Soma das d√≠vidas por ano (Data de Vencimento)</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Recupera√ß√£o ATUALIZADA -->
                <div id="recuperacao-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Widget 1: Gr√°fico de √çndice de Cr√©dito Recuperado (%) -->
                    <div id="widget-credito-recuperado" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-credito-recuperado')">√çndice de Cr√©dito Recuperado (%)</h2>
                        <canvas id="creditoRecuperadoChart"></canvas>
                    </div>

                    <!-- Widget 2: Card de Varia√ß√£o (Recupera√ß√£o) ATUALIZADO -->
                    <div id="widget-variacao-recuperacao" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4">Varia√ß√£o entre m√™s atual e anterior</h2>
                        <div class="text-center mb-4">
                            <p class="text-sm text-gray-400 mb-1">Compara√ß√£o autom√°tica dos √∫ltimos 2 meses</p>
                            <p class="text-xs text-gray-500">Metodologia: (M√™s Atual - M√™s Anterior) √∑ M√™s Anterior √ó 100</p>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold cursor-pointer" id="recuperacao-variacao-text-rec" onclick="showInfoBox('recuperacao')">üí∞ <span id="recuperacao-variacao-rec">0,00</span>%</p>
                                <p class="text-gray-400">Recupera√ß√£o</p>
                                <p class="text-xs text-gray-500" id="recuperacao-detalhes">Carregando dados...</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold cursor-pointer" id="inadimplencia-variacao-text-rec" onclick="showInfoBox('inadimplencia')">‚ö†Ô∏è <span id="inadimplencia-variacao-rec">0,00</span>%</p>
                                <p class="text-gray-400">Inadimpl√™ncia</p>
                                <p class="text-xs text-gray-500" id="inadimplencia-detalhes">Carregando dados...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Widget 3: Parcelas Monitoradas RESTAURADO -->
                    <div id="widget-parcelas-monitoradas" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Parcelas Monitoradas</h2>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded-full" id="total-parcelas-monitoradas">0</span>
                                <button class="btn-limpar-filtros text-xs" onclick="limparFiltrosMultiplos()" title="Limpar todos os filtros">
                                    üóëÔ∏è Limpar filtros
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informa√ß√£o de filtros m√∫ltiplos -->
                        <div class="filtros-multiplos-info" id="filtros-multiplos-info">
                            <strong>Filtros ativos:</strong> 
                            <span id="filtros-selecionados-texto"></span> | 
                            <span id="contador-filtros-multiplos"></span> parcelas √∫nicas
                            <button onclick="limparFiltrosMultiplos()" class="btn-limpar-filtros-multiplos">Limpar</button>
                        </div>
                        
                        <!-- Filtros CLIC√ÅVEIS COM SELE√á√ÉO M√öLTIPLA -->
                        <div class="filtros-container">
                            <div class="filtros-header">
                                <div class="text-sm text-gray-400">Filtros de Probabilidade (selecione m√∫ltiplos):</div>
                                <button onclick="limparFiltrosMultiplos()" class="btn-limpar-filtros" title="Limpar todos os filtros">
                                    üóëÔ∏è Limpar filtros
                                </button>
                            </div>
                            
                            <div class="flex flex-wrap gap-1">
                                <span class="filter-badge active" data-filtro="todas" onclick="alternarFiltro('todas')">Todas</span>
                                <span class="filter-badge" data-filtro="alta" onclick="alternarFiltro('alta')">Alta Prob.</span>
                                <span class="filter-badge" data-filtro="media" onclick="alternarFiltro('media')">M√©dia Prob.</span>
                                <span class="filter-badge" data-filtro="baixa" onclick="alternarFiltro('baixa')">Baixa Prob.</span>
                                <span class="filter-badge" data-filtro="pago-atraso" onclick="alternarFiltro('pago-atraso')">Pago em atraso</span>
                                <span class="filter-badge" data-filtro="dentro-prazo" onclick="alternarFiltro('dentro-prazo')">Dentro do prazo</span>
                            </div>
                        </div>
                        
                        <!-- Lista de Parcelas COM BOT√ÉO DE EDI√á√ÉO -->
                        <div class="parcelas-monitoradas-container" id="lista-parcelas">
                            <p class="text-gray-400 text-center p-4">Nenhuma parcela monitorada encontrada. Processe uma planilha na se√ß√£o Planilhas.</p>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            <p>‚Ä¢ <strong>Alta probabilidade:</strong> Diferen√ßa > 7 dias</p>
                            <p>‚Ä¢ <strong>M√©dia probabilidade:</strong> Diferen√ßa 3-7 dias</p>
                            <p>‚Ä¢ <strong>Baixa probabilidade:</strong> Diferen√ßa 1-2 dias ou negativa</p>
                            <p>‚Ä¢ <strong>Pago em atraso:</strong> Data baixa ap√≥s vencimento real + probabilidade</p>
                            <p>‚Ä¢ <strong>Dentro do prazo:</strong> Data baixa dentro do vencimento real + probabilidade</p>
                        </div>
                    </div>

                    <!-- Widget 4: Tabela de Pagamentos por M√™s -->
                    <div id="widget-pagamentos-mes" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300 col-span-3">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Pagamentos Recebidos por M√™s</h2>
                            <div class="toggle-atrasados">
                                <label for="toggle-mostrar-atrasados">Mostrar apenas atrasados (desconsiderar "dentro do prazo")</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="toggle-mostrar-atrasados" onchange="alternarMostrarApenasAtrasados()">
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informa√ß√£o sobre toggle -->
                        <div id="info-toggle-atrasados" class="mb-4 p-3 bg-blue-900/30 rounded-lg border border-blue-700 hidden">
                            <strong>üìä Modo: Mostrando apenas pagamentos em atraso</strong><br>
                            <span class="text-sm">Valor total desconsidera "Recebidos dentro do prazo" (at√© 2 dias de toler√¢ncia)</span>
                        </div>
                        
                        <div id="tabelas-pagamentos-mes" class="overflow-y-auto max-h-[600px]">
                            <p class="text-gray-400 text-center p-4">Nenhum dado de pagamento processado ainda. Fa√ßa o upload de uma planilha na se√ß√£o Planilhas.</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Cr√©ditime -->
                <div id="credtime-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Widget 4: Gr√°fico de An√°lise de Cr√©dito -->
                    <div id="widget-analise-credito-credtime" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-analise-credito-credtime')">An√°lise de Cr√©dito</h2>
                        <canvas id="analiseCreditoChartCredtime"></canvas>
                    </div>

                    <!-- Novo Widget: Prazo M√©dio de An√°lise de Cr√©dito -->
                    <div id="widget-prazo-analise" class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300">
                        <h2 class="text-lg font-semibold mb-4 cursor-pointer" onclick="maximizeWidget('widget-prazo-analise')">Prazo M√©dio de An√°lise de Cr√©dito</h2>
                        <canvas id="prazoAnaliseChart"></canvas>
                    </div>
                </div>

                <!-- Se√ß√£o Planilhas ATUALIZADA -->
                <div id="planilhas-section" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Painel de Upload -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-6 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">üì§ Upload de Planilhas</h2>
                            
                            <!-- √Årea de Upload -->
                            <div class="upload-area mb-4" id="uploadArea" 
                                 onclick="document.getElementById('fileInput').click()"
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 ondrop="handleDrop(event)">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">üìä</div>
                                    <p class="text-lg font-medium mb-2">Clique ou arraste arquivos aqui</p>
                                    <p class="text-sm text-gray-400">Suporte para: .xlsx, .xls, .csv</p>
                                    <p class="text-xs text-gray-500 mt-2">Tipos de dados: Pagamentos, Atrasados, Saldos, Cr√©ditos Analisados</p>
                                </div>
                            </div>
                            
                            <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(event)">
                            
                            <!-- Lista de Arquivos -->
                            <div class="file-list" id="fileList">
                                <h3 class="text-sm font-semibold mb-2 text-gray-300">Arquivos Carregados:</h3>
                                <div id="uploadedFiles" class="space-y-2">
                                    <!-- Arquivos ser√£o listados aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Painel de Configura√ß√£o de Processamento -->
                        <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-6 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è Configura√ß√£o de Processamento</h2>
                            
                            <!-- Sele√ß√£o de Arquivo -->
                            <div class="config-section">
                                <label class="config-label">Arquivo Selecionado:</label>
                                <select id="selectedFile" class="config-select">
                                    <option value="">Selecione um arquivo...</option>
                                </select>
                            </div>

                            <!-- Tipo de Dados -->
                            <div class="config-section">
                                <label class="config-label">Tipo de Dados:</label>
                                <select id="dataType" class="config-select" onchange="updateProcessingOptions()">
                                    <option value="">Selecione o tipo...</option>
                                    <option value="pagamentos">üí∞ Pagamentos (Recupera√ß√£o)</option>
                                    <option value="atrasados">‚ö†Ô∏è Atrasados</option>
                                    <option value="saldos">üí≥ Saldos de Contas</option>
                                    <option value="creditos">üìà Cr√©ditos Analisados</option>
                                    <option value="outros">üìã Outros</option>
                                </select>
                            </div>

                            <!-- Configura√ß√µes espec√≠ficas para Pagamentos ATUALIZADA -->
                            <div class="config-section" id="pagamentosConfig" style="display: none;">
                                <label class="config-label">Configura√ß√£o de Colunas para Pagamentos:</label>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Nro Nota:</label>
                                        <input type="text" id="pagamentosNroNota" class="config-input" placeholder="Ex: A, Nro Nota">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Nome Parceiro:</label>
                                        <input type="text" id="pagamentosNomeParceiro" class="config-input" placeholder="Ex: B, Nome Parceiro">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Vlr do Desdobramento:</label>
                                        <input type="text" id="pagamentosVlrDesdobramento" class="config-input" placeholder="Ex: C, Vlr do Desdobramento">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Vlr Juros:</label>
                                        <input type="text" id="pagamentosVlrJuros" class="config-input" placeholder="Ex: D, Vlr Juros">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Vlr Baixa:</label>
                                        <input type="text" id="pagamentosVlrBaixa" class="config-input" placeholder="Ex: E, Vlr Baixa">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Dt. Vencimento:</label>
                                        <input type="text" id="pagamentosDtVencimento" class="config-input" placeholder="Ex: F, Dt. Vencimento">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Data Baixa:</label>
                                        <input type="text" id="pagamentosDataBaixa" class="config-input" placeholder="Ex: G, Data Baixa">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Nome Fantasia:</label>
                                        <input type="text" id="pagamentosNomeFantasia" class="config-input" placeholder="Ex: H, Nome Fantasia">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Descri√ß√£o:</label>
                                        <input type="text" id="pagamentosDescricao" class="config-input" placeholder="Ex: I, Descri√ß√£o">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna NSU:</label>
                                        <input type="text" id="pagamentosNSU" class="config-input" placeholder="Ex: J, NSU">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Desdob.:</label>
                                        <input type="text" id="pagamentosDesdob" class="config-input" placeholder="Ex: K, Desdob.">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Apelido:</label>
                                        <input type="text" id="pagamentosApelido" class="config-input" placeholder="Ex: L, Apelido">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Hist√≥rico:</label>
                                        <input type="text" id="pagamentosHistorico" class="config-input" placeholder="Ex: M, Hist√≥rico">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Dt. Negocia√ß√£o:</label>
                                        <input type="text" id="pagamentosDtNegociacao" class="config-input" placeholder="Ex: N, Dt. Negocia√ß√£o">
                                    </div>
                                </div>
                                
                                <!-- Configura√ß√£o de Detec√ß√£o de Altera√ß√µes ATUALIZADA -->
                                <div class="mt-4 p-3 bg-gray-900 rounded-lg border border-gray-600">
                                    <label class="text-xs text-gray-400 font-semibold">üîç Configura√ß√£o de Detec√ß√£o de Altera√ß√µes:</label>
                                    <div class="mt-2 grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-400">Dias padr√£o entre parcelas:</label>
                                            <input type="number" id="diasEntreParcelas" class="config-input" value="30" min="1" max="90" onchange="recalcularDetecao()">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-400">Toler√¢ncia para "dentro do prazo" (dias):</label>
                                            <input type="number" id="toleranciaDias" class="config-input" value="2" min="0" max="30" onchange="recalcularDetecao(); atualizarCategorizacaoPagamentos()">
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">O sistema calcular√° a data estimada de vencimento e comparar√° com o vencimento real. A probabilidade ser√° aplicada apenas quando a rela√ß√£o entre data de vencimento e data de baixa N√ÉO MOSTRAR atraso real.</p>
                                </div>
                            </div>

                            <!-- Configura√ß√µes espec√≠ficas para Atrasados -->
                            <div class="config-section" id="atrasadosConfig" style="display: none;">
                                <label class="config-label">Configura√ß√£o de Colunas para Atrasados:</label>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Nro √∫nico:</label>
                                        <input type="text" id="atrasadosNroUnico" class="config-input" placeholder="Ex: A, Nro √∫nico">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna CNPJ / CPF:</label>
                                        <input type="text" id="atrasadosCnpjCpf" class="config-input" placeholder="Ex: B, CNPJ / CPF">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna C√≥d. Parceiro:</label>
                                        <input type="text" id="atrasadosCodParceiro" class="config-input" placeholder="Ex: C, C√≥d. Parceiro">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Parceiro:</label>
                                        <input type="text" id="atrasadosParceiro" class="config-input" placeholder="Ex: D, Parceiro">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Telefone:</label>
                                        <input type="text" id="atrasadosTelefone" class="config-input" placeholder="Ex: E, Telefone">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Desdob.:</label>
                                        <input type="text" id="atrasadosDesdob" class="config-input" placeholder="Ex: F, Desdob.">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna E-mail:</label>
                                        <input type="text" id="atrasadosEmail" class="config-input" placeholder="Ex: G, E-mail">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna C√≥d. Natureza:</label>
                                        <input type="text" id="atrasadosCodNatureza" class="config-input" placeholder="Ex: H, C√≥d. Natureza">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Natureza:</label>
                                        <input type="text" id="atrasadosNatureza" class="config-input" placeholder="Ex: I, Natureza">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Nro Nota:</label>
                                        <input type="text" id="atrasadosNroNota" class="config-input" placeholder="Ex: J, Nro Nota">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Data Emiss√£o:</label>
                                        <input type="text" id="atrasadosDataEmissao" class="config-input" placeholder="Ex: K, Data Emiss√£o">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Data Vencimento:</label>
                                        <input type="text" id="atrasadosDataVencimento" class="config-input" placeholder="Ex: L, Data Vencimento">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Dias em Atraso:</label>
                                        <input type="text" id="atrasadosDiasAtraso" class="config-input" placeholder="Ex: M, Dias em Atraso">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna C√≥d. Tipo T√≠tulo:</label>
                                        <input type="text" id="atrasadosCodTipoTitulo" class="config-input" placeholder="Ex: N, C√≥d. Tipo T√≠tulo">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Tipo T√≠tulo:</label>
                                        <input type="text" id="atrasadosTipoTitulo" class="config-input" placeholder="Ex: O, Tipo T√≠tulo">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna C√≥d. Tipo Negocia√ß√£o:</label>
                                        <input type="text" id="atrasadosCodTipoNegociacao" class="config-input" placeholder="Ex: P, C√≥d. Tipo Negocia√ß√£o">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Tipo Negocia√ß√£o:</label>
                                        <input type="text" id="atrasadosTipoNegociacao" class="config-input" placeholder="Ex: Q, Tipo Negocia√ß√£o">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Observa√ß√£o:</label>
                                        <input type="text" id="atrasadosObservacao" class="config-input" placeholder="Ex: R, Observa√ß√£o">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Coluna Valor:</label>
                                        <input type="text" id="atrasadosValor" class="config-input" placeholder="Ex: S, Valor">
                                    </div>
                                </div>
                                
                                <!-- Configura√ß√£o de Exporta√ß√£o para Inadimpl√™ncia -->
                                <div class="mt-4 p-3 bg-red-900/30 rounded-lg border border-red-700">
                                    <label class="text-xs text-gray-400 font-semibold">üì§ Exporta√ß√£o para √çndice de Inadimpl√™ncia:</label>
                                    <div class="mt-2">
                                        <label class="text-xs text-gray-400">Selecione o m√™s para exporta√ß√£o:</label>
                                        <select id="atrasadosMesExportacao" class="config-input mt-1">
                                            <option value="Abril/25">Abril/25</option>
                                            <option value="Maio/25">Maio/25</option>
                                            <option value="Junho/25">Junho/25</option>
                                            <option value="Julho/25">Julho/25</option>
                                            <option value="Agosto/25">Agosto/25</option>
                                            <option value="Setembro/25">Setembro/25</option>
                                            <option value="Outubro/25">Outubro/25</option>
                                            <option value="Novembro/25">Novembro/25</option>
                                            <option value="Dezembro/25">Dezembro/25</option>
                                        </select>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">O valor total dos atrasados ser√° somado e exportado automaticamente para a tabela "√çndice de Inadimpl√™ncia" na se√ß√£o Configura√ß√µes.</p>
                                </div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="flex space-x-2 mt-4">
                                <button onclick="processSpreadsheet()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300 flex-1">
                                    üîÑ Processar
                                </button>
                                <button onclick="previewData()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-300 flex-1">
                                    üëÅÔ∏è Visualizar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Painel de Resultados -->
                    <div class="mt-6 bg-gradient-to-br from-gray-800 to-gray-700 p-6 rounded-lg shadow-lg" id="resultsPanel" style="display: none;">
                        <h2 class="text-xl font-semibold mb-4">üìä Resultados do Processamento</h2>
                        
                        <!-- Estat√≠sticas Gerais -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-900 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-400" id="totalRecords">0</div>
                                <div class="text-sm text-gray-400">Total de Registros</div>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-400" id="totalValue">R$ 0,00</div>
                                <div class="text-sm text-gray-400">Valor Total</div>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-400" id="avgValue">R$ 0,00</div>
                                <div class="text-sm text-gray-400">Valor M√©dio</div>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-400" id="monthsCount">0</div>
                                <div class="text-sm text-gray-400">Meses Processados</div>
                            </div>
                        </div>

                        <!-- NOVA SE√á√ÉO: Detec√ß√£o de Altera√ß√µes -->
                        <div class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-600" id="alteracoesSection" style="display: none;">
                            <h3 class="text-lg font-semibold mb-3 text-yellow-400">üîç Detec√ß√£o de Altera√ß√µes em Vencimentos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-red-400" id="totalAlteracoes">0</div>
                                    <div class="text-sm text-gray-400">Parcelas com poss√≠vel altera√ß√£o</div>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-400" id="mediaDiferenca">0</div>
                                    <div class="text-sm text-gray-400">Diferen√ßa m√©dia (dias)</div>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-400" id="clientesAfetados">0</div>
                                    <div class="text-sm text-gray-400">Clientes afetados</div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto max-h-[400px]">
                                <table class="w-full text-left" id="alteracoesTable">
                                    <thead>
                                        <tr class="text-gray-400 bg-gray-800">
                                            <th class="p-2">Cliente</th>
                                            <th class="p-2">Parcela</th>
                                            <th class="p-2">Venc. Estimado</th>
                                            <th class="p-2">Venc. Real</th>
                                            <th class="p-2">Diferen√ßa</th>
                                            <th class="p-2">Probabilidade</th>
                                            <th class="p-2">Status Pagamento</th>
                                            <th class="p-2">M√©todo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alteracoesBody">
                                        <!-- Dados de altera√ß√µes ser√£o inseridos aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tabela de Dados Processados -->
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-left" id="processedDataTable">
                                <thead>
                                    <tr class="text-gray-400 bg-gray-900">
                                        <th class="p-2">M√™s</th>
                                        <th class="p-2">Valor</th>
                                        <th class="p-2">Registros</th>
                                        <th class="p-2">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="processedDataBody">
                                    <!-- Dados processados ser√£o inseridos aqui -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Bot√µes de Exporta√ß√£o -->
                        <div class="flex space-x-2 mt-4">
                            <button onclick="exportToConfig()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition duration-300">
                                üì§ Exportar para Configura√ß√µes
                            </button>
                            <button onclick="downloadProcessed()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition duration-300">
                                üíæ Download Processado
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Renegociar -->
                <div id="renegociar-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300 col-span-3">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Renegociar (Detalhado)</h2>
                            <div class="flex items-center space-x-4">
                                <input type="text" id="search-renegociar" placeholder="Pesquisar..." class="border rounded p-2 text-black">
                                <button onclick="searchRenegociar()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">Pesquisar</button>
                            </div>
                        </div>

                        <!-- Controles no topo -->
                        <div class="mb-4 p-4 bg-gray-900 rounded-lg border border-gray-600">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <label for="discount-input" class="text-gray-400 mr-2">Desconto (%):</label>
                                        <input type="number" id="discount-input" value="0" min="0" max="100" step="0.01" class="w-20 p-1 rounded bg-gray-700 text-white border border-gray-600" onchange="updateDetailedStatistics(); saveDataToLocalStorage();">
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="addDetailedRow()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">Adicionar Linha</button>
                                        <button onclick="removeDetailedRow()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition duration-300" id="remove-row-btn">Excluir Linha</button>
                                    </div>
                                </div>
                                
                                <!-- Estat√≠sticas fixas no topo -->
                                <div id="detailed-statistics" class="p-3 bg-gray-800 rounded-lg border border-gray-600">
                                    <h3 class="text-sm font-semibold mb-2 text-blue-300">Estat√≠sticas (1 parcelas) - desconto 0%</h3>
                                    <div class="grid grid-cols-5 gap-2 text-xs">
                                        <div>
                                            <span class="text-gray-400">Soma Parcelas:</span><br>
                                            <span class="text-green-400 font-medium">R$ 0,00</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400">Soma Multas:</span><br>
                                            <span class="text-yellow-400 font-medium">R$ 0,00</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400">M√©dia Vencimento:</span><br>
                                            <span class="text-blue-400 font-medium">N/A</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400">Maior Atraso:</span><br>
                                            <span class="text-red-400 font-medium">0 dias</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400">Soma Subtotal:</span><br>
                                            <span class="text-green-400 font-medium font-bold">R$ 0,00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabela Renegociar -->
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full text-left border-collapse mb-4" id="renegociar-table">
                                <thead class="sticky top-0 bg-gray-900">
                                    <tr class="bg-gray-900 text-gray-200">
                                        <th class="p-2 border-b-2 border-gray-600">$ PARCELA</th>
                                        <th class="p-2 border-b-2 border-gray-600">MULTA 15%</th>
                                        <th class="p-2 border-b-2 border-gray-600">VENCIMENTO</th>
                                        <th class="p-2 border-b-2 border-gray-600">ATRASO</th>
                                        <th class="p-2 border-b-2 border-gray-600">JUROS DIA</th>
                                        <th class="p-2 border-b-2 border-gray-600">SUBTOTAL</th>
                                        <th class="p-2 border-b-2 border-gray-600">NOTA</th>
                                        <th class="p-2 border-b-2 border-gray-600">Custas</th>
                                    </tr>
                                </thead>
                                <tbody id="renegociar-table-body-detalhado">
                                    <!-- Linhas ser√£o geradas dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="info-box" class="info-box">
                    <span class="close-btn" onclick="hideInfoBox()">√ó</span>
                    <p id="info-content"></p>
                </div>
            </main>
        </div>

        <!-- Ferramentas de C√≥pia Flutuantes -->
        <div id="copy-tools" class="copy-tools">
            <div class="copy-buttons">
                <button onclick="copyColumnValues()" class="copy-btn">Copiar Coluna</button>
                <button onclick="copySelectedValues()" class="copy-btn">Copiar Sele√ß√£o</button>
                <button onclick="clearSelection()" class="copy-btn">Limpar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let highlightedWidget = null;
        let uploadedFiles = [];
        let processedData = {};
        let chartInstances = {};
        let pagamentosProcessados = {};
        let parcelasMonitoradas = [];
        let filtrosSelecionados = new Set(['todas']);
        let dadosDedupFiltrados = [];
        let pagamentosRawData = [];
        let pagamentosFiltrados = [];
        let selectedCells = new Set();
        let isSelecting = false;
        let startCell = null;
        let parcelaEditandoIndex = null;
        let statusEditandoSelecionado = null;
        let mostrarApenasAtrasados = false;
        let atrasadosProcessados = [];
        let estatisticasCobranca = {};
        let notasParceirosData = {};
        let parcelasAtrasadas = [];
        let filtrosAtrasadosSelecionados = new Set(['todos']);

        // ========== FUN√á√ÉO DE ENTRADA NO DASHBOARD ==========
        function enterDashboard() {
            const splash = document.getElementById('splashScreen');
            const dashboard = document.getElementById('dashboardMain');
            
            // Remover tela de apresenta√ß√£o
            splash.classList.add('hidden');
            
            // Mostrar dashboard com anima√ß√£o
            setTimeout(() => {
                dashboard.classList.add('show');
                initializeDashboard();
                
                // Inicializar gr√°ficos ap√≥s um pequeno delay
                setTimeout(() => {
                    initializeAllCharts();
                }, 300);
            }, 100);
        }

        // ========== FUN√á√ÉO PARA MAXIMIZAR WIDGETS ==========
        function maximizeWidget(widgetId) {
            const widget = document.getElementById(widgetId);
            const allWidgets = document.querySelectorAll('[id^="widget-"]');
            
            // Verificar se j√° est√° maximizado
            if (widget.classList.contains('maximized')) {
                // Restaurar tamanho normal
                widget.classList.remove('maximized', 'fixed', 'inset-0', 'z-50', 'w-full', 'h-full', 'm-0');
                widget.style.width = '';
                widget.style.height = '';
                widget.style.position = '';
                widget.style.zIndex = '';
                
                // Remover bot√£o de fechar se existir
                const closeBtn = widget.querySelector('.close-maximize-btn');
                if (closeBtn) closeBtn.remove();
                
                allWidgets.forEach(w => w.classList.remove('hidden'));
            } else {
                // Maximizar widget
                widget.classList.add('maximized', 'fixed', 'inset-0', 'z-50', 'w-full', 'h-full', 'm-0');
                widget.style.width = '100%';
                widget.style.height = '100%';
                widget.style.position = 'fixed';
                widget.style.zIndex = '1000';
                widget.style.top = '0';
                widget.style.left = '0';
                
                // Adicionar bot√£o de fechar
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-maximize-btn absolute top-4 right-4 bg-red-600 text-white p-2 rounded-full z-10';
                closeBtn.innerHTML = '‚úï';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    widget.classList.remove('maximized', 'fixed', 'inset-0', 'z-50', 'w-full', 'h-full', 'm-0');
                    widget.style.width = '';
                    widget.style.height = '';
                    widget.style.position = '';
                    widget.style.zIndex = '';
                    closeBtn.remove();
                    allWidgets.forEach(w => w.classList.remove('hidden'));
                };
                widget.appendChild(closeBtn);
                
                // Esconder outros widgets
                allWidgets.forEach(w => {
                    if (w.id !== widgetId) {
                        w.classList.add('hidden');
                    }
                });
            }
        }

        // Atualizar listeners dos widgets para usar maximizeWidget
        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar todos os t√≠tulos de widgets para usar maximizeWidget
            const widgetTitles = document.querySelectorAll('[id^="widget-"] h2');
            widgetTitles.forEach(title => {
                const widgetId = title.closest('[id^="widget-"]').id;
                title.style.cursor = 'pointer';
                title.onclick = (e) => {
                    e.stopPropagation();
                    maximizeWidget(widgetId);
                };
            });
        });

        // ========== FUN√á√ïES PARA PARCELAS ATRASADAS ==========
        function alternarFiltroAtrasado(filtro) {
            if (filtro === 'todos') {
                filtrosAtrasadosSelecionados.clear();
                filtrosAtrasadosSelecionados.add('todos');
                atualizarBadgesFiltrosAtrasados();
                aplicarFiltroAtrasados();
                return;
            }
            
            if (filtrosAtrasadosSelecionados.has('todos')) {
                filtrosAtrasadosSelecionados.delete('todos');
            }
            
            if (filtrosAtrasadosSelecionados.has(filtro)) {
                filtrosAtrasadosSelecionados.delete(filtro);
            } else {
                filtrosAtrasadosSelecionados.add(filtro);
            }
            
            if (filtrosAtrasadosSelecionados.size === 0) {
                filtrosAtrasadosSelecionados.add('todos');
            }
            
            atualizarBadgesFiltrosAtrasados();
            aplicarFiltroAtrasados();
        }

        function atualizarBadgesFiltrosAtrasados() {
            const badges = document.querySelectorAll('.filter-badge-atrasado');
            badges.forEach(badge => {
                const filtro = badge.getAttribute('data-filtro');
                badge.classList.remove('active');
                
                if (filtro === 'todos' && filtrosAtrasadosSelecionados.has('todos')) {
                    badge.classList.add('active');
                } else if (filtrosAtrasadosSelecionados.has(filtro)) {
                    badge.classList.add('active');
                }
            });
        }

        function aplicarFiltroAtrasados() {
            if (filtrosAtrasadosSelecionados.has('todos')) {
                atualizarListaParcelasAtrasadas(parcelasAtrasadas);
            } else {
                const filtrosArray = Array.from(filtrosAtrasadosSelecionados);
                const parcelasFiltradas = parcelasAtrasadas.filter(parcela => {
                    return filtrosArray.some(filtro => {
                        return parcela.statusTag === filtro || parcela.statusTag?.toLowerCase().includes(filtro);
                    });
                });
                atualizarListaParcelasAtrasadas(parcelasFiltradas);
            }
        }

        function atualizarListaParcelasAtrasadas(parcelas) {
            const lista = document.getElementById('lista-parcelas-atrasadas');
            document.getElementById('total-parcelas-atrasadas').textContent = parcelas.length;
            
            if (parcelas.length === 0) {
                lista.innerHTML = '<p class="text-gray-400 text-center p-4">Nenhuma parcela em atraso encontrada.</p>';
                return;
            }
            
            let html = '';
            parcelas.forEach((parcela, index) => {
                html += `
                    <div class="parcela-item alta-probabilidade pago-atraso" data-parcela-index="${index}">
                        <div class="parcela-header">
                            <div class="parcela-cliente">${parcela.parceiro}</div>
                            <div class="flex items-center gap-2">
                                <div class="parcela-probabilidade">${parcela.statusTag || 'EM ATRASO'}</div>
                                <button class="btn-editar-status" onclick="editarStatusAtrasado(${index}, event)">üè∑Ô∏è Tag</button>
                            </div>
                        </div>
                        <div class="parcela-detalhes">
                            <div class="detalhe-item">
                                <span class="detalhe-label">Nota:</span>
                                <span class="detalhe-valor">${parcela.nroNota || 'N/A'}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Vencimento:</span>
                                <span class="detalhe-valor">${parcela.dataVencimento || 'N/A'}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Dias em Atraso:</span>
                                <span class="detalhe-valor text-red-400">${parcela.diasAtraso || 0}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Valor:</span>
                                <span class="detalhe-valor">R$ ${formatBrazilianNumber(parcela.valor || 0)}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Natureza:</span>
                                <span class="detalhe-valor">${parcela.natureza || 'N/A'}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">CNPJ/CPF:</span>
                                <span class="detalhe-valor">${parcela.cnpjCpf || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        function editarStatusAtrasado(index, event) {
            event.stopPropagation();
            
            const parcela = parcelasAtrasadas[index];
            
            // Criar modal para selecionar tag
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-80 z-10000 flex justify-center items-center">
                    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-lg font-semibold mb-4">üè∑Ô∏è Selecionar Tag para ${parcela.parceiro}</h3>
                        <div class="grid grid-cols-2 gap-2 mb-4" id="opcoesTagAtrasado">
                            ${['NOTIFICADOS', 'AJUIZADOS', 'ACORDO - CLIENTE REC. JUDICIAL', 'ACORDOS ASSINADOS', 
                               'PARCEIROS (ESTRAT√âGICOS)', 'PREESCRITOS', 'VALOR INFERIOR', 
                               'NEGOCIA√á√ÉO EM ANDAMENTO', '√Ä NEGOCIAR'].map(tag => `
                                <button onclick="aplicarTagAtrasado(${index}, '${tag}')" 
                                        class="p-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                                    ${tag}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="fecharModalTag()" class="w-full p-2 bg-red-600 hover:bg-red-700 rounded">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'modal-tag-atrasado';
            modal.innerHTML = modalHTML;
            document.body.appendChild(modal);
        }

        function aplicarTagAtrasado(index, tag) {
            if (!parcelasAtrasadas[index]) return;
            
            parcelasAtrasadas[index].statusTag = tag;
            atualizarListaParcelasAtrasadas(parcelasAtrasadas);
            fecharModalTag();
            saveDataToLocalStorage();
        }

        function fecharModalTag() {
            const modal = document.getElementById('modal-tag-atrasado');
            if (modal) modal.remove();
        }

        function limparFiltrosAtrasados() {
            filtrosAtrasadosSelecionados.clear();
            filtrosAtrasadosSelecionados.add('todos');
            atualizarBadgesFiltrosAtrasados();
            aplicarFiltroAtrasados();
        }

        // ========== FUN√á√ÉO PARA ALTERNAR FILTROS (SELE√á√ÉO M√öLTIPLA) ==========
        function alternarFiltro(tipo) {
            if (tipo === 'todas') {
                filtrosSelecionados.clear();
                filtrosSelecionados.add('todas');
                atualizarBadgesFiltros();
                aplicarFiltroMultiplo();
                return;
            }
            
            if (filtrosSelecionados.has('todas')) {
                filtrosSelecionados.delete('todas');
            }
            
            if (filtrosSelecionados.has(tipo)) {
                filtrosSelecionados.delete(tipo);
            } else {
                filtrosSelecionados.add(tipo);
            }
            
            if (filtrosSelecionados.size === 0) {
                filtrosSelecionados.add('todas');
            }
            
            atualizarBadgesFiltros();
            aplicarFiltroMultiplo();
        }

        function atualizarBadgesFiltros() {
            const badges = document.querySelectorAll('.filter-badge');
            badges.forEach(badge => {
                const filtro = badge.getAttribute('data-filtro');
                badge.classList.remove('active', 'selected', 'partial', 'multiple-select');
                
                if (filtro === 'todas' && filtrosSelecionados.has('todas')) {
                    badge.classList.add('active');
                } else if (filtrosSelecionados.has(filtro)) {
                    badge.classList.add('selected');
                    if (filtrosSelecionados.size > 1 && !filtrosSelecionados.has('todas')) {
                        badge.classList.add('multiple-select');
                    }
                }
            });
            
            atualizarInfoFiltrosMultiplos();
        }

        function aplicarFiltroMultiplo() {
            if (filtrosSelecionados.has('todas')) {
                dadosDedupFiltrados = deduplicarDados(pagamentosRawData);
                atualizarListaParcelasVisualMultiplo(Array.from(filtrosSelecionados));
            } else {
                filtrarDadosMultiplos(Array.from(filtrosSelecionados));
            }
            
            atualizarTabelaPagamentosMultiplos();
            saveDataToLocalStorage();
        }

        function filtrarDadosMultiplos(filtros) {
            if (filtros.length === 0) return;
            
            const dadosFiltrados = pagamentosRawData.filter(pagamento => {
                const parcelaCorrespondente = parcelasMonitoradas.find(parcela => {
                    return correspondeParcelaPagamento(parcela, pagamento);
                });
                
                if (!parcelaCorrespondente) return false;
                
                return filtros.some(filtro => {
                    switch(filtro) {
                        case 'alta': return parcelaCorrespondente.probabilidade === 'alta';
                        case 'media': return parcelaCorrespondente.probabilidade === 'media';
                        case 'baixa': return parcelaCorrespondente.probabilidade === 'baixa';
                        case 'pago-atraso': return parcelaCorrespondente.statusPagamento === 'Pago em atraso';
                        case 'dentro-prazo': return parcelaCorrespondente.statusPagamento === 'Dentro do prazo';
                        default: return false;
                    }
                });
            });
            
            dadosDedupFiltrados = deduplicarDados(dadosFiltrados);
        }

        function deduplicarDados(dados) {
            if (!dados || dados.length === 0) return [];
            
            const duplicadosMap = new Map();
            const dadosUnicos = [];
            
            dados.forEach(pagamento => {
                const chaveUnica = criarChaveUnicaPagamento(pagamento);
                if (!duplicadosMap.has(chaveUnica)) {
                    duplicadosMap.set(chaveUnica, true);
                    dadosUnicos.push(pagamento);
                }
            });
            
            return dadosUnicos;
        }

        function criarChaveUnicaPagamento(pagamento) {
            const nome = (pagamento.nome || '').toLowerCase().trim();
            const valor = pagamento.valorDesdobramento || pagamento.valorLiquido || 0;
            const vencimento = pagamento.vencimento || '';
            const dataBaixa = pagamento.dataBaixa || '';
            const numeroParcela = pagamento.numeroParcela || pagamento.totalParcelasPagas || 0;
            const contratoNota = pagamento.nroNota || '';
            const valorFormatado = valor.toFixed(2);
            
            return `${nome}|${valorFormatado}|${vencimento}|${dataBaixa}|${numeroParcela}|${contratoNota}`;
        }

        function correspondeParcelaPagamento(parcela, pagamento) {
            const criterios = [];
            
            if (parcela.cliente && pagamento.nome) {
                const nomeClienteParcela = parcela.cliente.toLowerCase();
                const nomeClientePagamento = pagamento.nome.toLowerCase();
                criterios.push(nomeClienteParcela.includes(nomeClientePagamento) || 
                              nomeClientePagamento.includes(nomeClienteParcela));
            }
            
            if (parcela.valor && pagamento.valorLiquido) {
                const diferencaValor = Math.abs(parcela.valor - pagamento.valorLiquido);
                criterios.push(diferencaValor < 0.01);
            }
            
            if (parcela.nota && pagamento.nroNota) {
                criterios.push(parcela.nota.toString() === pagamento.nroNota.toString());
            }
            
            if (parcela.vencimentoReal && pagamento.vencimento) {
                const dataParcela = parseExcelDate(parcela.vencimentoReal);
                const dataPagamento = parseExcelDate(pagamento.vencimento);
                if (dataParcela && dataPagamento) {
                    const diferencaDias = Math.abs((dataParcela - dataPagamento) / (1000 * 60 * 60 * 24));
                    criterios.push(diferencaDias <= 2);
                }
            }
            
            const criteriosAtendidos = criterios.filter(Boolean).length;
            return criteriosAtendidos >= 2;
        }

        // ========== ATUALIZAR LISTA VISUAL DE PARCELAS ==========
        function atualizarListaParcelasVisualMultiplo(filtros) {
            let parcelasFiltradas = [];
            
            if (filtros.includes('todas')) {
                parcelasFiltradas = parcelasMonitoradas;
            } else {
                parcelasFiltradas = parcelasMonitoradas.filter(parcela => {
                    return filtros.some(filtro => {
                        switch(filtro) {
                            case 'alta': return parcela.probabilidade === 'alta';
                            case 'media': return parcela.probabilidade === 'media';
                            case 'baixa': return parcela.probabilidade === 'baixa';
                            case 'pago-atraso': return parcela.statusPagamento === 'Pago em atraso';
                            case 'dentro-prazo': return parcela.statusPagamento === 'Dentro do prazo';
                            default: return false;
                        }
                    });
                });
            }
            
            document.getElementById('total-parcelas-monitoradas').textContent = parcelasFiltradas.length;
            const lista = document.getElementById('lista-parcelas');
            
            if (parcelasFiltradas.length === 0) {
                let mensagem = '<p class="text-gray-400 text-center p-4">';
                if (parcelasMonitoradas.length === 0) {
                    mensagem += 'Nenhuma parcela monitorada encontrada. Processe uma planilha na se√ß√£o Planilhas.';
                } else if (!filtros.includes('todas')) {
                    mensagem += `Nenhuma parcela encontrada com os filtros selecionados.`;
                } else {
                    mensagem += 'Nenhuma parcela encontrada.';
                }
                mensagem += '</p>';
                lista.innerHTML = mensagem;
                return;
            }
            
            let html = '';
            parcelasFiltradas.forEach((parcela, index) => {
                let classeProbabilidade = `parcela-item ${parcela.probabilidade}-probabilidade`;
                
                if (parcela.statusPagamento === 'Pago em atraso') {
                    classeProbabilidade += ' pago-atraso';
                } else if (parcela.statusPagamento === 'Dentro do prazo') {
                    classeProbabilidade += ' dentro-prazo';
                }
                
                html += `
                    <div class="${classeProbabilidade}" data-parcela-index="${index}">
                        <div class="parcela-header">
                            <div class="parcela-cliente">${parcela.cliente}</div>
                            <div class="flex items-center gap-2">
                                <div class="parcela-probabilidade">${parcela.probabilidade.toUpperCase()}</div>
                                <button class="btn-editar-status" onclick="editarStatusParcela(${index}, event)">‚úèÔ∏è Editar Status</button>
                            </div>
                        </div>
                        <div class="parcela-detalhes" onclick="verDetalhesParcela(${index})">
                            <div class="detalhe-item">
                                <span class="detalhe-label">Parcela:</span>
                                <span class="detalhe-valor">${parcela.parcela}/${parcela.totalParcelas}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Venc. Estimado:</span>
                                <span class="detalhe-valor">${parcela.vencimentoEstimado}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Venc. Real:</span>
                                <span class="detalhe-valor">${parcela.vencimentoReal}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Data Baixa:</span>
                                <span class="detalhe-valor">${parcela.dataBaixa}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Diferen√ßa:</span>
                                <span class="detalhe-valor ${parcela.diferencaDias > 0 ? 'diferenca-negativa' : 'diferenca-positiva'}">
                                    ${parcela.diferencaDias > 0 ? '+' : ''}${parcela.diferencaDias} dias
                                </span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Status:</span>
                                <span class="detalhe-valor ${parcela.statusPagamento === 'Pago em atraso' ? 'text-red-400' : parcela.statusPagamento === 'Dentro do prazo' ? 'text-green-400' : 'text-yellow-400'}">
                                    ${parcela.statusPagamento}
                                </span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">Valor:</span>
                                <span class="detalhe-valor">R$ ${formatBrazilianNumber(parcela.valor)}</span>
                            </div>
                            <div class="detalhe-item">
                                <span class="detalhe-label">M√©todo:</span>
                                <span class="detalhe-valor">${parcela.metodoCalculo}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }

        // ========== ATUALIZAR TABELA DE PAGAMENTOS ==========
        function atualizarTabelaPagamentosMultiplos() {
            if (dadosDedupFiltrados.length === 0) {
                document.getElementById('tabelas-pagamentos-mes').innerHTML = 
                    '<p class="text-gray-400 text-center p-4">Nenhum dado de pagamento encontrado para os filtros selecionados.</p>';
                return;
            }
            
            const pagamentosPorMesFiltrados = {};
            const categorias = [
                'Recebidos dentro do prazo',
                'Recebidos de 01 √† 15 dias',
                'Recebidos de 16 √† 30 dias',
                'Recebidos de 31 √† 90 dias',
                'Recebidos acima 91 dias'
            ];
            
            const pagamentosValidos = dadosDedupFiltrados.filter(p => p.mesAno !== 'Desconhecido');
            
            pagamentosValidos.forEach(p => {
                if (!pagamentosPorMesFiltrados[p.mesAno]) {
                    pagamentosPorMesFiltrados[p.mesAno] = {};
                    categorias.forEach(cat => {
                        pagamentosPorMesFiltrados[p.mesAno][cat] = { quantidade: 0, valor: 0 };
                    });
                }
                
                pagamentosPorMesFiltrados[p.mesAno][p.categoria].quantidade += 1;
                pagamentosPorMesFiltrados[p.mesAno][p.categoria].valor += p.valorLiquido;
            });
            
            gerarTabelasPagamentosMultiplos(pagamentosPorMesFiltrados);
        }

        function gerarTabelasPagamentosMultiplos(dadosPagamentos) {
            const container = document.getElementById('tabelas-pagamentos-mes');
            container.innerHTML = '';
            
            const meses = Object.keys(dadosPagamentos).sort((a, b) => {
                const [mesA, anoA] = a.split('/').map(Number);
                const [mesB, anoB] = b.split('/').map(Number);
                if (anoA !== anoB) return anoA - anoB;
                return mesA - mesB;
            });
            
            if (meses.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center p-4">Nenhum dado de pagamento encontrado para os filtros selecionados.</p>';
                return;
            }
            
            const tolerancia = parseInt(document.getElementById('toleranciaDias').value) || 2;
            const filtrosArray = Array.from(filtrosSelecionados);
            const isTodas = filtrosArray.includes('todas');
            const filtrosAtivos = isTodas ? ['Todas'] : filtrosArray;
            
            const filtrosNomes = {
                'alta': 'Alta Probabilidade',
                'media': 'M√©dia Probabilidade', 
                'baixa': 'Baixa Probabilidade',
                'pago-atraso': 'Pago em Atraso',
                'dentro-prazo': 'Dentro do Prazo',
                'todas': 'Todas'
            };
            
            const filtrosTexto = filtrosAtivos.map(f => filtrosNomes[f] || f).join(' + ');
            
            const filtroInfo = `
                <div class="mb-4 p-3 bg-blue-900/30 rounded-lg border border-blue-700">
                    <strong>Filtros Ativos:</strong> ${filtrosTexto} | 
                    <strong>Registros √önicos:</strong> ${dadosDedupFiltrados.length} de ${pagamentosRawData.length} |
                    <button onclick="limparFiltrosMultiplos()" class="btn-limpar-filtros-multiplos">üóëÔ∏è Limpar Filtros</button>
                </div>`;
            
            container.innerHTML = filtroInfo;
            
            const infoToggle = document.getElementById('info-toggle-atrasados');
            if (mostrarApenasAtrasados) {
                infoToggle.classList.remove('hidden');
            } else {
                infoToggle.classList.add('hidden');
            }
            
            meses.forEach(mes => {
                const data = dadosPagamentos[mes];
                
                let totalQuantidade = 0;
                let totalValor = 0;
                
                Object.entries(data).forEach(([categoria, valores]) => {
                    if (!mostrarApenasAtrasados || categoria !== 'Recebidos dentro do prazo') {
                        totalQuantidade += valores.quantidade;
                        totalValor += valores.valor;
                    }
                });
                
                const valorRecuperadoAtrasados = 
                    (data['Recebidos de 01 √† 15 dias']?.valor || 0) +
                    (data['Recebidos de 16 √† 30 dias']?.valor || 0) +
                    (data['Recebidos de 31 √† 90 dias']?.valor || 0) +
                    (data['Recebidos acima 91 dias']?.valor || 0);
                
                const tabelaHTML = `
                    <div class="payment-table-container">
                        <div class="payment-table-title">
                            M√™s: ${mes} (Toler√¢ncia: ${tolerancia} dias) - Filtros: ${filtrosTexto}
                            <div class="exportar-recuperacao-container mt-2">
                                <div class="text-sm text-gray-300 mb-2">
                                    <strong>Valor recuperado (apenas atrasados):</strong> R$ ${formatBrazilianNumber(valorRecuperadoAtrasados)}
                                    ${mostrarApenasAtrasados ? '‚ö†Ô∏è Desconsiderando "Recebidos dentro do prazo"' : ''}
                                </div>
                                <div class="exportar-recuperacao-botoes">
                                    <button class="btn-exportar-recuperacao" onclick="exportarParaRecuperacao('${mes}', ${valorRecuperadoAtrasados})">
                                        üì§ Exportar para Recupera√ß√£o
                                    </button>
                                </div>
                            </div>
                        </div>
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-900 text-gray-200">
                                    <th class="p-2 border-b-2 border-gray-600">Categoria</th>
                                    <th class="p-2 border-b-2 border-gray-600">Total de Pagamentos</th>
                                    <th class="p-2 border-b-2 border-gray-600">Valor Pago</th>
                                    <th class="p-2 border-b-2 border-gray-600">% em rela√ß√£o ao total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mostrarApenasAtrasados ? '' : `
                                <tr class="payment-category-row">
                                    <td class="p-2">Recebidos dentro do prazo (at√© ${tolerancia} dias)</td>
                                    <td class="p-2">${data['Recebidos dentro do prazo'].quantidade}</td>
                                    <td class="p-2">${formatBrazilianNumber(data['Recebidos dentro do prazo'].valor)}</td>
                                    <td class="p-2">${totalValor > 0 ? (data['Recebidos dentro do prazo'].valor / totalValor * 100).toFixed(2) + '%' : '0%'}</td>
                                </tr>
                                `}
                                <tr class="payment-category-row">
                                    <td class="p-2">Recebidos de 01 √† 15 dias</td>
                                    <td class="p-2">${data['Recebidos de 01 √† 15 dias'].quantidade}</td>
                                    <td class="p-2">${formatBrazilianNumber(data['Recebidos de 01 √† 15 dias'].valor)}</td>
                                    <td class="p-2">${totalValor > 0 ? (data['Recebidos de 01 √† 15 dias'].valor / totalValor * 100).toFixed(2) + '%' : '0%'}</td>
                                </tr>
                                <tr class="payment-category-row">
                                    <td class="p-2">Recebidos de 16 √† 30 dias</td>
                                    <td class="p-2">${data['Recebidos de 16 √† 30 dias'].quantidade}</td>
                                    <td class="p-2">${formatBrazilianNumber(data['Recebidos de 16 √† 30 dias'].valor)}</td>
                                    <td class="p-2">${totalValor > 0 ? (data['Recebidos de 16 √† 30 dias'].valor / totalValor * 100).toFixed(2) + '%' : '0%'}</td>
                                </tr>
                                <tr class="payment-category-row">
                                    <td class="p-2">Recebidos de 31 √† 90 dias</td>
                                    <td class="p-2">${data['Recebidos de 31 √† 90 dias'].quantidade}</td>
                                    <td class="p-2">${formatBrazilianNumber(data['Recebidos de 31 √† 90 dias'].valor)}</td>
                                    <td class="p-2">${totalValor > 0 ? (data['Recebidos de 31 √† 90 dias'].valor / totalValor * 100).toFixed(2) + '%' : '0%'}</td>
                                </tr>
                                <tr class="payment-category-row">
                                    <td class="p-2">Recebidos acima 91 dias</td>
                                    <td class="p-2">${data['Recebidos acima 91 dias'].quantidade}</td>
                                    <td class="p-2">${formatBrazilianNumber(data['Recebidos acima 91 dias'].valor)}</td>
                                    <td class="p-2">${totalValor > 0 ? (data['Recebidos acima 91 dias'].valor / totalValor * 100).toFixed(2) + '%' : '0%'}</td>
                                </tr>
                                <tr class="payment-total-row">
                                    <td class="p-2 font-bold">TOTAL ${mostrarApenasAtrasados ? '(APENAS ATRASADOS)' : '(√öNICOS)'}</td>
                                    <td class="p-2 font-bold">${totalQuantidade}</td>
                                    <td class="p-2 font-bold">${formatBrazilianNumber(totalValor)}</td>
                                    <td class="p-2 font-bold">100%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML += tabelaHTML;
            });
        }

        function atualizarInfoFiltrosMultiplos() {
            const infoDiv = document.getElementById('filtros-multiplos-info');
            const textoFiltros = document.getElementById('filtros-selecionados-texto');
            const contadorFiltros = document.getElementById('contador-filtros-multiplos');
            
            if (!infoDiv || !textoFiltros || !contadorFiltros) return;
            
            const filtrosArray = Array.from(filtrosSelecionados);
            const isTodas = filtrosArray.includes('todas');
            
            if (isTodas || filtrosArray.length === 0) {
                infoDiv.classList.remove('active');
            } else {
                infoDiv.classList.add('active');
                
                const filtrosNomes = {
                    'alta': 'Alta Probabilidade',
                    'media': 'M√©dia Probabilidade', 
                    'baixa': 'Baixa Probabilidade',
                    'pago-atraso': 'Pago em Atraso',
                    'dentro-prazo': 'Dentro do Prazo'
                };
                
                const filtrosTexto = filtrosArray.map(f => filtrosNomes[f] || f).join(' + ');
                textoFiltros.textContent = filtrosTexto;
                contadorFiltros.textContent = dadosDedupFiltrados.length;
            }
        }

        function limparFiltrosMultiplos() {
            filtrosSelecionados.clear();
            filtrosSelecionados.add('todas');
            dadosDedupFiltrados = deduplicarDados(pagamentosRawData);
            
            atualizarBadgesFiltros();
            atualizarListaParcelasVisualMultiplo(Array.from(filtrosSelecionados));
            atualizarTabelaPagamentosMultiplos();
            
            saveDataToLocalStorage();
        }

        // ========== TOGGLE MOSTRAR APENAS ATRASADOS ==========
        function alternarMostrarApenasAtrasados() {
            const toggle = document.getElementById('toggle-mostrar-atrasados');
            mostrarApenasAtrasados = toggle.checked;
            atualizarTabelaPagamentosMultiplos();
        }

        // ========== EXPORTAR PARA RECUPERA√á√ÉO ==========
        function exportarParaRecuperacao(mes, valorRecuperado) {
            const [mesNum, ano] = mes.split('/').map(Number);
            const mesesNomes = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            
            const nomeMes = mesesNomes[mesNum - 1];
            const mesFormatado = `${nomeMes}/${ano}`;
            
            const tabelaRecuperacao = document.querySelector('#configuracoes-section .bg-gradient-to-br:nth-child(2) tbody');
            const linhas = tabelaRecuperacao.querySelectorAll('tr');
            
            let pagamentosForaDoMes = [];
            
            if (dadosDedupFiltrados.length > 0) {
                pagamentosForaDoMes = dadosDedupFiltrados.filter(p => {
                    return p.mesAno !== 'Desconhecido' && p.mesAno !== mes;
                });
            }
            
            let mensagem = `
                <h3 class="text-lg font-semibold mb-3 text-blue-400">üì§ Exportar para Recupera√ß√£o</h3>
                <p><strong>M√™s selecionado:</strong> ${mesFormatado}</p>
                <p><strong>Valor recuperado (apenas atrasados):</strong> R$ ${formatBrazilianNumber(valorRecuperado)}</p>
            `;
            
            if (pagamentosForaDoMes.length > 0) {
                mensagem += `
                    <div class="mt-3 p-3 bg-yellow-900/30 rounded-lg border border-yellow-700">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> ${pagamentosForaDoMes.length} pagamentos t√™m m√™s diferente de ${mes}
                        <div class="mt-2 text-sm">
                            <strong>Meses encontrados:</strong>
                            <ul class="list-disc pl-5 mt-1">
                `;
                
                const mesesFora = {};
                pagamentosForaDoMes.forEach(p => {
                    if (!mesesFora[p.mesAno]) {
                        mesesFora[p.mesAno] = {
                            quantidade: 0,
                            valor: 0
                        };
                    }
                    mesesFora[p.mesAno].quantidade++;
                    mesesFora[p.mesAno].valor += p.valorLiquido;
                });
                
                Object.entries(mesesFora).forEach(([mesFora, dados]) => {
                    const [mesF, anoF] = mesFora.split('/').map(Number);
                    const nomeMesFora = mesesNomes[mesF - 1];
                    mensagem += `
                        <li class="fora-do-mes">
                            ${nomeMesFora}/${anoF}: ${dados.quantidade} pagamentos (R$ ${formatBrazilianNumber(dados.valor)})
                        </li>
                    `;
                });
                
                mensagem += `
                            </ul>
                            <p class="mt-2">Considere editar a planilha e subir novamente se esses pagamentos n√£o forem do m√™s ${mesFormatado}.</p>
                        </div>
                    </div>
                `;
            }
            
            mensagem += `
                <div class="mt-4">
                    <label class="text-sm text-gray-300 mb-2 block">Selecione a linha para preencher:</label>
                    <select id="select-mes-recuperacao" class="config-select mb-3">
            `;
            
            linhas.forEach((linha, index) => {
                const celulaMes = linha.querySelector('td:first-child');
                if (celulaMes) {
                    const mesLinha = celulaMes.textContent.trim();
                    mensagem += `<option value="${index}">${mesLinha}</option>`;
                }
            });
            
            mensagem += `
                    </select>
                    <div class="exportar-recuperacao-botoes">
                        <button class="btn-exportar-recuperacao cancelar" onclick="fecharModalDetalhes()">Cancelar</button>
                        <button class="btn-exportar-recuperacao" onclick="preencherValorRecuperado(${valorRecuperado})">Preencher Valor</button>
                    </div>
                </div>
            `;
            
            const modalConteudo = document.getElementById('modalDetalhesConteudo');
            const modalInterpretacao = document.getElementById('modalInterpretacao');
            
            modalConteudo.innerHTML = mensagem;
            modalInterpretacao.innerHTML = `
                <div class="modal-interpretacao-titulo">üìã Exporta√ß√£o para √çndice de Recupera√ß√£o</div>
                <div class="modal-interpretacao-texto">
                    Esta funcionalidade preenche automaticamente o valor recuperado na tabela "√çndice de Recupera√ß√£o" da se√ß√£o Configura√ß√µes.
                    <br><br>
                    <strong>Nota:</strong> O valor inclui apenas pagamentos em atraso (desconsidera "Recebidos dentro do prazo").
                </div>
            `;
            
            document.getElementById('modalDetalhesParcela').classList.add('active');
            document.querySelector('.modal-titulo').textContent = 'üì§ Exportar para Recupera√ß√£o';
        }

        function preencherValorRecuperado(valor) {
            const select = document.getElementById('select-mes-recuperacao');
            const indiceLinha = parseInt(select.value);
            
            const tabelaRecuperacao = document.querySelector('#configuracoes-section .bg-gradient-to-br:nth-child(2) tbody');
            const linhas = tabelaRecuperacao.querySelectorAll('tr');
            
            if (indiceLinha >= 0 && indiceLinha < linhas.length) {
                const linha = linhas[indiceLinha];
                const celulaValor = linha.querySelector('td:nth-child(2)');
                
                if (celulaValor) {
                    celulaValor.textContent = formatBrazilianNumber(valor);
                    celulaValor.classList.add('manual-edit');
                    
                    const event = new Event('blur');
                    celulaValor.dispatchEvent(event);
                    
                    fecharModalDetalhes();
                    alert(`Valor de R$ ${formatBrazilianNumber(valor)} preenchido com sucesso!`);
                    
                    setTimeout(() => {
                        showSection('configuracoes');
                        const tabela = document.querySelector('#configuracoes-section .bg-gradient-to-br:nth-child(2)');
                        if (tabela) {
                            tabela.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 500);
                }
            }
        }

        // ========== EDI√á√ÉO DE STATUS ==========
        function editarStatusParcela(index, event) {
            event.stopPropagation();
            
            if (index < 0 || index >= parcelasMonitoradas.length) {
                console.error('√çndice de parcela inv√°lido:', index);
                return;
            }
            
            parcelaEditandoIndex = index;
            const parcela = parcelasMonitoradas[index];
            
            const infoDiv = document.getElementById('editarStatusInfo');
            infoDiv.innerHTML = `
                <div class="mb-4 p-3 bg-gray-800 rounded-lg">
                    <strong>Cliente:</strong> ${parcela.cliente}<br>
                    <strong>Parcela:</strong> ${parcela.parcela}/${parcela.totalParcelas}<br>
                    <strong>Valor:</strong> R$ ${formatBrazilianNumber(parcela.valor)}<br>
                    <strong>Status atual:</strong> <span class="${parcela.statusPagamento === 'Pago em atraso' ? 'text-red-400' : parcela.statusPagamento === 'Dentro do prazo' ? 'text-green-400' : 'text-yellow-400'}">${parcela.statusPagamento}</span><br>
                    <strong>Probabilidade atual:</strong> ${parcela.probabilidade.toUpperCase()}
                </div>
            `;
            
            const opcoesDiv = document.getElementById('opcoesStatus');
            const opcoes = [
                {
                    id: 'alta',
                    titulo: 'Alta Probabilidade',
                    descricao: 'Diferen√ßa > 7 dias',
                    icone: 'üî¥',
                    statusPagamento: parcela.statusPagamento,
                    probabilidade: 'alta'
                },
                {
                    id: 'media',
                    titulo: 'M√©dia Probabilidade',
                    descricao: 'Diferen√ßa 3-7 dias',
                    icone: 'üü°',
                    statusPagamento: parcela.statusPagamento,
                    probabilidade: 'media'
                },
                {
                    id: 'baixa',
                    titulo: 'Baixa Probabilidade',
                    descricao: 'Diferen√ßa 1-2 dias ou negativa',
                    icone: 'üîµ',
                    statusPagamento: parcela.statusPagamento,
                    probabilidade: 'baixa'
                },
                {
                    id: 'pago-atraso',
                    titulo: 'Pago em atraso',
                    descricao: 'Data baixa ap√≥s vencimento real',
                    icone: '‚ùå',
                    statusPagamento: 'Pago em atraso',
                    probabilidade: parcela.probabilidade
                },
                {
                    id: 'dentro-prazo',
                    titulo: 'Dentro do prazo',
                    descricao: 'Data baixa dentro do vencimento real',
                    icone: '‚úÖ',
                    statusPagamento: 'Dentro do prazo',
                    probabilidade: parcela.probabilidade
                }
            ];
            
            let opcoesHTML = '';
            opcoes.forEach(opcao => {
                const isSelecionada = 
                    (opcao.probabilidade === parcela.probabilidade && opcao.statusPagamento === parcela.statusPagamento) ||
                    (opcao.id === 'alta' && parcela.probabilidade === 'alta') ||
                    (opcao.id === 'media' && parcela.probabilidade === 'media') ||
                    (opcao.id === 'baixa' && parcela.probabilidade === 'baixa') ||
                    (opcao.id === 'pago-atraso' && parcela.statusPagamento === 'Pago em atraso') ||
                    (opcao.id === 'dentro-prazo' && parcela.statusPagamento === 'Dentro do prazo');
                
                if (isSelecionada) {
                    statusEditandoSelecionado = opcao.id;
                }
                
                opcoesHTML += `
                    <div class="opcao-status ${isSelecionada ? 'selecionada' : ''}" 
                         data-opcao-id="${opcao.id}"
                         onclick="selecionarOpcaoStatus('${opcao.id}')">
                        <div class="icone-status">${opcao.icone}</div>
                        <div class="texto-status">
                            <div class="titulo-status">${opcao.titulo}</div>
                            <div class="descricao-status">${opcao.descricao}</div>
                        </div>
                    </div>
                `;
            });
            
            opcoesDiv.innerHTML = opcoesHTML;
            document.getElementById('modalEditarStatus').classList.add('active');
        }

        function selecionarOpcaoStatus(opcaoId) {
            statusEditandoSelecionado = opcaoId;
            
            document.querySelectorAll('.opcao-status').forEach(opcao => {
                opcao.classList.remove('selecionada');
            });
            
            const opcaoSelecionada = document.querySelector(`.opcao-status[data-opcao-id="${opcaoId}"]`);
            if (opcaoSelecionada) {
                opcaoSelecionada.classList.add('selecionada');
            }
        }

        function salvarStatusParcela() {
            if (parcelaEditandoIndex === null || statusEditandoSelecionado === null) {
                alert('Selecione uma op√ß√£o antes de salvar.');
                return;
            }
            
            const parcela = parcelasMonitoradas[parcelaEditandoIndex];
            
            switch(statusEditandoSelecionado) {
                case 'alta':
                    parcela.probabilidade = 'alta';
                    break;
                case 'media':
                    parcela.probabilidade = 'media';
                    break;
                case 'baixa':
                    parcela.probabilidade = 'baixa';
                    break;
                case 'pago-atraso':
                    parcela.statusPagamento = 'Pago em atraso';
                    break;
                case 'dentro-prazo':
                    parcela.statusPagamento = 'Dentro do prazo';
                    break;
            }
            
            atualizarListaParcelasVisualMultiplo(Array.from(filtrosSelecionados));
            saveDataToLocalStorage();
            fecharModalEditarStatus();
            alert('Status da parcela atualizado com sucesso!');
        }

        function fecharModalEditarStatus() {
            document.getElementById('modalEditarStatus').classList.remove('active');
            parcelaEditandoIndex = null;
            statusEditandoSelecionado = null;
        }

        // ========== FUN√á√ïES DE PERSIST√äNCIA ==========
        function saveDataToLocalStorage() {
            try {
                const editableCells = document.querySelectorAll('[contenteditable="true"]');
                const editableData = {};
                
                editableCells.forEach((cell, index) => {
                    const tableId = cell.closest('table')?.id || cell.closest('[id*="table"]')?.id || 'unknown';
                    const rowIndex = cell.closest('tr')?.rowIndex || 0;
                    const cellIndex = cell.cellIndex || 0;
                    
                    const uniqueKey = `${tableId}-row${rowIndex}-cell${cellIndex}`;
                    editableData[uniqueKey] = cell.innerHTML;
                });
                
                const renegociarLines = [];
                const renegociarLinesElements = document.querySelectorAll('#renegociar-table-body-detalhado tr');
                renegociarLinesElements.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const lineData = {
                        parcela: cells[0]?.textContent || '',
                        multa: cells[1]?.textContent || '',
                        vencimento: cells[2]?.textContent || '',
                        atraso: cells[3]?.textContent || '',
                        juros: cells[4]?.textContent || '',
                        subtotal: cells[5]?.textContent || '',
                        nota: cells[6]?.textContent || '',
                        custas: cells[7]?.textContent || ''
                    };
                    renegociarLines.push(lineData);
                });
                
                const discount = document.getElementById('discount-input')?.value || '0';
                const pagamentosData = pagamentosProcessados;
                const parcelasData = parcelasMonitoradas;
                const pagamentosRaw = pagamentosRawData;
                const dadosDedup = dadosDedupFiltrados;
                const filtrosSelecionadosArray = Array.from(filtrosSelecionados);
                const toggleAtrasados = mostrarApenasAtrasados;
                const atrasadosData = atrasadosProcessados;
                const estatisticasCobrancaData = estatisticasCobranca;
                const notasParceirosDataSaved = notasParceirosData;
                const parcelasAtrasadasData = parcelasAtrasadas;
                const filtrosAtrasadosSelecionadosArray = Array.from(filtrosAtrasadosSelecionados);
                
                const dataToSave = {
                    editableData,
                    renegociarLines,
                    discount,
                    pagamentosData,
                    parcelasData,
                    pagamentosRaw,
                    dadosDedup,
                    filtrosSelecionados: filtrosSelecionadosArray,
                    toggleAtrasados,
                    atrasadosData,
                    estatisticasCobranca: estatisticasCobrancaData,
                    notasParceirosData: notasParceirosDataSaved,
                    parcelasAtrasadas: parcelasAtrasadasData,
                    filtrosAtrasadosSelecionados: filtrosAtrasadosSelecionadosArray,
                    lastSave: new Date().toISOString()
                };
                
                localStorage.setItem('dashboardData', JSON.stringify(dataToSave));
                saveCompanyName();
            } catch (error) {
                console.error('Erro ao salvar dados no localStorage:', error);
            }
        }

        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('dashboardData');
                if (!savedData) {
                    loadCompanyName();
                    return;
                }
                
                const data = JSON.parse(savedData);
                
                if (data.editableData) {
                    const editableCells = document.querySelectorAll('[contenteditable="true"]');
                    editableCells.forEach((cell, index) => {
                        const tableId = cell.closest('table')?.id || cell.closest('[id*="table"]')?.id || 'unknown';
                        const rowIndex = cell.closest('tr')?.rowIndex || 0;
                        const cellIndex = cell.cellIndex || 0;
                        
                        const uniqueKey = `${tableId}-row${rowIndex}-cell${cellIndex}`;
                        if (data.editableData[uniqueKey]) {
                            cell.innerHTML = data.editableData[uniqueKey];
                            if (cell.innerHTML !== cell.getAttribute('data-default') && !cell.classList.contains('manual-edit')) {
                                cell.classList.add('manual-edit');
                            }
                        }
                    });
                }
                
                if (data.discount && document.getElementById('discount-input')) {
                    document.getElementById('discount-input').value = data.discount;
                }
                
                if (data.renegociarLines) {
                    initRenegociarTableFromData(data.renegociarLines);
                }
                
                if (data.pagamentosData) {
                    pagamentosProcessados = data.pagamentosData;
                }
                
                if (data.parcelasData) {
                    parcelasMonitoradas = data.parcelasData;
                }
                
                if (data.pagamentosRaw) {
                    pagamentosRawData = data.pagamentosRaw;
                }
                
                if (data.dadosDedup) {
                    dadosDedupFiltrados = data.dadosDedup;
                }
                
                if (data.filtrosSelecionados) {
                    filtrosSelecionados = new Set(data.filtrosSelecionados);
                }
                
                if (data.toggleAtrasados !== undefined) {
                    mostrarApenasAtrasados = data.toggleAtrasados;
                    const toggle = document.getElementById('toggle-mostrar-atrasados');
                    if (toggle) {
                        toggle.checked = mostrarApenasAtrasados;
                    }
                }
                
                if (data.atrasadosData) {
                    atrasadosProcessados = data.atrasadosData;
                }
                
                if (data.estatisticasCobranca) {
                    estatisticasCobranca = data.estatisticasCobranca;
                }
                
                if (data.notasParceirosData) {
                    notasParceirosData = data.notasParceirosData;
                }
                
                if (data.parcelasAtrasadas) {
                    parcelasAtrasadas = data.parcelasAtrasadas;
                }
                
                if (data.filtrosAtrasadosSelecionados) {
                    filtrosAtrasadosSelecionados = new Set(data.filtrosAtrasadosSelecionados);
                }
                
                loadCompanyName();
                
                setTimeout(() => {
                    atualizarBadgesFiltros();
                    atualizarBadgesFiltrosAtrasados();
                    
                    if (parcelasMonitoradas.length > 0) {
                        atualizarListaParcelasVisualMultiplo(Array.from(filtrosSelecionados));
                        atualizarTabelaPagamentosMultiplos();
                    }
                    
                    if (estatisticasCobranca && Object.keys(estatisticasCobranca).length > 0) {
                        atualizarEstatisticasCobrancaUI();
                    }
                    
                    if (notasParceirosData && Object.keys(notasParceirosData).length > 0) {
                        atualizarNotasParceirosUI();
                    }
                    
                    if (atrasadosProcessados.length > 0) {
                        atualizarAtrasosAnoUI();
                        atualizarIndicesHistoricosUI();
                    }
                    
                    if (parcelasAtrasadas.length > 0) {
                        atualizarListaParcelasAtrasadas(parcelasAtrasadas);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
                loadCompanyName();
            }
        }

        // ========== FUN√á√ïES DE GR√ÅFICOS ==========
        function updateChart(canvasId, config) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const ctx = canvas.getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, config);
        }

        function getInadimplenciaData() {
            const rows = document.querySelectorAll('#inadimplencia-table tbody tr');
            const labels = [];
            const totalAtrasado = [];
            const totalContas = [];
            const indices = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const mes = cells[0].textContent.trim();
                const atrasado = parseNumber(cells[1].textContent);
                const contas = parseNumber(cells[2].textContent);
                
                if (atrasado > 0 || contas > 0) {
                    labels.push(mes);
                    totalAtrasado.push(atrasado);
                    totalContas.push(contas);
                    indices.push(contas > 0 ? (atrasado / contas * 100) : 0);
                }
            });

            return { labels, totalAtrasado, totalContas, indices };
        }

        function getRecuperacaoData() {
            const rows = document.querySelectorAll('#configuracoes-section .bg-gradient-to-br:nth-child(2) tbody tr');
            const labels = [];
            const valorRecuperado = [];
            const totalAtrasado = [];
            const indices = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const mes = cells[0].textContent.trim();
                const recuperado = parseNumber(cells[1].textContent);
                const atrasado = parseNumber(cells[2].textContent);
                
                if (recuperado > 0 || atrasado > 0) {
                    labels.push(mes);
                    valorRecuperado.push(recuperado);
                    totalAtrasado.push(atrasado);
                    indices.push(atrasado > 0 ? (recuperado / atrasado * 100) : 0);
                }
            });

            return { labels, valorRecuperado, totalAtrasado, indices };
        }

        function getAnaliseCreditoData() {
            const rows = document.querySelectorAll('#configuracoes-section .bg-gradient-to-br:nth-child(3) tbody tr');
            const labels = [];
            const mediaAnalises = [];
            const totalAnalises = [];
            const prazoMedio = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const mes = cells[0].textContent.trim();
                const media = parseFloat(cells[1].textContent) || 0;
                const total = parseInt(cells[2].textContent) || 0;
                const prazo = cells[3].textContent.trim();
                
                if (total > 0) {
                    labels.push(mes);
                    mediaAnalises.push(media);
                    totalAnalises.push(total);
                    prazoMedio.push(prazo);
                }
            });

            return { labels, mediaAnalises, totalAnalises, prazoMedio };
        }

        function getPrazoMedioData() {
            const rows = document.querySelectorAll('#configuracoes-section .bg-gradient-to-br:nth-child(3) tbody tr');
            const labels = [];
            const prazos = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const mes = cells[0].textContent.trim();
                const prazoText = cells[3].textContent.trim();
                
                let minutos = 0;
                const horasMatch = prazoText.match(/(\d+)h/);
                const minutosMatch = prazoText.match(/(\d+)min/);
                
                if (horasMatch) minutos += parseInt(horasMatch[1]) * 60;
                if (minutosMatch) minutos += parseInt(minutosMatch[1]);
                
                if (minutos > 0) {
                    labels.push(mes);
                    prazos.push(minutos);
                }
            });

            return { labels, prazos };
        }

        function getNotasParceirosData() {
            // Usar dados processados da planilha de atrasados
            if (notasParceirosData && Object.keys(notasParceirosData).length > 0) {
                const anos = Object.keys(notasParceirosData).sort((a, b) => b - a);
                const notas = [];
                const parceiros = [];
                
                anos.forEach(ano => {
                    notas.push(notasParceirosData[ano].notas || 0);
                    parceiros.push(notasParceirosData[ano].parceiros || 0);
                });
                
                return { labels: anos, notas, parceiros };
            }
            
            // Fallback para dados da tabela
            const rows = document.querySelectorAll('#notas-parceiros-table-body tr');
            const labels = [];
            const notas = [];
            const parceiros = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const mes = cells[0]?.textContent.trim();
                const notasVal = parseInt(cells[1]?.textContent) || 0;
                const parceirosVal = parseInt(cells[2]?.textContent) || 0;
                
                if (mes && (notasVal > 0 || parceirosVal > 0)) {
                    labels.push(mes);
                    notas.push(notasVal);
                    parceiros.push(parceirosVal);
                }
            });

            return { labels, notas, parceiros };
        }

        function getAtrasosAnoData() {
            // Usar dados processados da planilha de atrasados
            if (atrasadosProcessados.length > 0) {
                const atrasosPorAno = {};
                
                atrasadosProcessados.forEach(atrasado => {
                    if (atrasado.dataVencimento) {
                        const vencDate = parseExcelDate(atrasado.dataVencimento);
                        if (vencDate) {
                            const ano = vencDate.getFullYear();
                            if (!atrasosPorAno[ano]) {
                                atrasosPorAno[ano] = {
                                    valor: 0,
                                    quantidade: 0
                                };
                            }
                            atrasosPorAno[ano].valor += atrasado.valor || 0;
                            atrasosPorAno[ano].quantidade += 1;
                        }
                    }
                });
                
                const anos = Object.keys(atrasosPorAno).sort();
                const valores = anos.map(ano => atrasosPorAno[ano].valor);
                const quantidades = anos.map(ano => atrasosPorAno[ano].quantidade);
                
                return { anos, valores, quantidades };
            }
            
            // Fallback para dados da tabela
            const rows = document.querySelectorAll('#atrasos-ano-table-body tr');
            const anos = [];
            const valores = [];
            const quantidades = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const ano = cells[0]?.textContent.trim();
                const valor = parseNumber(cells[1]?.textContent) || 0;
                const quantidade = parseInt(cells[2]?.textContent) || 0;
                
                if (ano && (valor > 0 || quantidade > 0)) {
                    anos.push(ano);
                    valores.push(valor);
                    quantidades.push(quantidade);
                }
            });

            return { anos, valores, quantidades };
        }

        function getCobrancaData() {
            const table = document.getElementById('cobranca-table-body');
            if (!table) return { categorias: [], quantidades: [], valores: [] };
            
            const rows = table.querySelectorAll('tr:not(.total-row)');
            const categorias = [];
            const quantidades = [];
            const valores = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const categoria = cells[0].textContent.trim();
                    const quantidade = parseInt(cells[1].textContent) || 0;
                    const valor = parseNumber(cells[2].textContent);
                    
                    if (categoria && categoria !== 'TOTAL INADIMPLENTES') {
                        categorias.push(categoria);
                        quantidades.push(quantidade);
                        valores.push(valor);
                    }
                }
            });

            return { categorias, quantidades, valores };
        }

        // ========== ATUALIZA√á√ÉO DE GR√ÅFICOS ==========
        function updateInadimplenciaCharts() {
            const data = getInadimplenciaData();
            
            updateChart('inadimplenciaChartInad', {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '√çndice de Inadimpl√™ncia (%)',
                        data: data.indices,
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            updateChart('valorInadimplenciaChartInad', {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Total Atrasado',
                        data: data.totalAtrasado,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatBrazilianNumber(value);
                                }
                            }
                        }
                    }
                }
            });

            updateCalculatedIndices('inadimplencia');
            updateVariationValues();
            updateHighlightsCharts();
        }

        function updateRecuperacaoCharts() {
            const data = getRecuperacaoData();
            
            updateChart('creditoRecuperadoChart', {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '√çndice de Recupera√ß√£o (%)',
                        data: data.indices,
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            updateCalculatedIndices('recuperacao');
            updateVariationValues();
            updateHighlightsCharts();
        }

        function updateAnaliseCreditoCharts() {
            const data = getAnaliseCreditoData();
            
            updateChart('analiseCreditoChartCredtime', {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Total de An√°lises',
                        data: data.totalAnalises,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            updateHighlightsCharts();
        }

        function updatePrazoMedioChart() {
            const data = getPrazoMedioData();
            
            updateChart('prazoAnaliseChart', {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Prazo M√©dio (minutos)',
                        data: data.prazos,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' min';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateNotasParceirosChart() {
            const data = getNotasParceirosData();
            
            updateChart('notasParceirosChartInad', {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Notas em Aberto',
                            data: data.notas,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Parceiros',
                            data: data.parceiros,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            updateHighlightsCharts();
        }

        function updateAtrasosAnoChart() {
            const data = getAtrasosAnoData();
            
            updateChart('atrasosAnoChartInad', {
                type: 'bar',
                data: {
                    labels: data.anos,
                    datasets: [{
                        label: 'Valor Total em Atraso',
                        data: data.valores,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatBrazilianNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCobrancaChart() {
            const data = getCobrancaData();
            
            updateChart('cobrancaPieChartInad', {
                type: 'pie',
                data: {
                    labels: data.categorias,
                    datasets: [{
                        data: data.valores,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(139, 92, 246, 0.7)',
                            'rgba(236, 72, 153, 0.7)',
                            'rgba(156, 163, 175, 0.7)',
                            'rgba(251, 191, 36, 0.7)',
                            'rgba(99, 102, 241, 0.7)'
                        ],
                        borderColor: [
                            'rgba(239, 68, 68, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(34, 197, 94, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(236, 72, 153, 1)',
                            'rgba(156, 163, 175, 1)',
                            'rgba(251, 191, 36, 1)',
                            'rgba(99, 102, 241, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        function updateCalculatedIndices(type) {
            if (type === 'inadimplencia') {
                const rows = document.querySelectorAll('#inadimplencia-table tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const atrasado = parseNumber(cells[1].textContent);
                    const contas = parseNumber(cells[2].textContent);
                    const indice = contas > 0 ? (atrasado / contas * 100) : 0;
                    cells[3].textContent = indice.toFixed(2) + '%';
                });
            } else if (type === 'recuperacao') {
                const rows = document.querySelectorAll('#configuracoes-section .bg-gradient-to-br:nth-child(2) tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const recuperado = parseNumber(cells[1].textContent);
                    const atrasado = parseNumber(cells[2].textContent);
                    const indice = atrasado > 0 ? (recuperado / atrasado * 100) : 0;
                    cells[3].textContent = indice.toFixed(2) + '%';
                });
            }
        }

        function updateHighlightsCharts() {
            // Gr√°fico de Inadimpl√™ncia para Highlights
            updateChart('inadimplenciaChartHighlight', {
                type: 'line',
                data: {
                    labels: getInadimplenciaData().labels,
                    datasets: [{
                        label: '√çndice de Inadimpl√™ncia (%)',
                        data: getInadimplenciaData().indices,
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico de Recupera√ß√£o para Highlights
            updateChart('recuperacaoChartHighlight', {
                type: 'line',
                data: {
                    labels: getRecuperacaoData().labels,
                    datasets: [{
                        label: '√çndice de Recupera√ß√£o (%)',
                        data: getRecuperacaoData().indices,
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico de Cr√©ditime para Highlights
            updateChart('credtimeChartHighlight', {
                type: 'pie',
                data: {
                    labels: getAnaliseCreditoData().labels,
                    datasets: [{
                        data: getAnaliseCreditoData().totalAnalises,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(139, 92, 246, 0.7)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(139, 92, 246, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            // Gr√°fico de Notas e Parceiros para Highlights
            const notasParceirosDataChart = getNotasParceirosData();
            updateChart('notasParceirosChartHighlight', {
                type: 'bar',
                data: {
                    labels: notasParceirosDataChart.labels,
                    datasets: [
                        {
                            label: 'Notas em Aberto',
                            data: notasParceirosDataChart.notas,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Parceiros',
                            data: notasParceirosDataChart.parceiros,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            updateVariationValues();
        }

        function updateVariationValues() {
            const recuperacaoData = getRecuperacaoData();
            const inadimplenciaData = getInadimplenciaData();
            
            // Atualizar recupera√ß√£o
            if (recuperacaoData.valorRecuperado.length >= 2) {
                const ultimoMes = recuperacaoData.valorRecuperado[recuperacaoData.valorRecuperado.length - 1] || 0;
                const penultimoMes = recuperacaoData.valorRecuperado[recuperacaoData.valorRecuperado.length - 2] || 0;
                const variacaoRec = penultimoMes > 0 ? ((ultimoMes - penultimoMes) / penultimoMes * 100) : 0;
                
                const ultimoMesLabel = recuperacaoData.labels[recuperacaoData.labels.length - 1] || 'Atual';
                const penultimoMesLabel = recuperacaoData.labels[recuperacaoData.labels.length - 2] || 'Anterior';
                
                document.getElementById('recuperacao-variacao-highlight').textContent = variacaoRec.toFixed(2);
                document.getElementById('recuperacao-variacao-rec').textContent = variacaoRec.toFixed(2);
                document.getElementById('recuperacao-detalhes').textContent = 
                    `${ultimoMesLabel}: R$ ${formatBrazilianNumber(ultimoMes)} | ${penultimoMesLabel}: R$ ${formatBrazilianNumber(penultimoMes)}`;
                
                const colorRec = variacaoRec >= 0 ? 'text-green-500' : 'text-red-500';
                document.getElementById('recuperacao-variacao-highlight-text').className = `text-2xl font-bold cursor-pointer ${colorRec}`;
                document.getElementById('recuperacao-variacao-text-rec').className = `text-2xl font-bold cursor-pointer ${colorRec}`;
            } else {
                document.getElementById('recuperacao-detalhes').textContent = 'Dados insuficientes para c√°lculo';
            }

            // Atualizar inadimpl√™ncia
            if (inadimplenciaData.totalAtrasado.length >= 2) {
                const ultimoMes = inadimplenciaData.totalAtrasado[inadimplenciaData.totalAtrasado.length - 1] || 0;
                const penultimoMes = inadimplenciaData.totalAtrasado[inadimplenciaData.totalAtrasado.length - 2] || 0;
                const variacaoInad = penultimoMes > 0 ? ((ultimoMes - penultimoMes) / penultimoMes * 100) : 0;
                
                const ultimoMesLabel = inadimplenciaData.labels[inadimplenciaData.labels.length - 1] || 'Atual';
                const penultimoMesLabel = inadimplenciaData.labels[inadimplenciaData.labels.length - 2] || 'Anterior';
                
                document.getElementById('inadimplencia-variacao-highlight').textContent = variacaoInad.toFixed(2);
                document.getElementById('inadimplencia-variacao-rec').textContent = variacaoInad.toFixed(2);
                document.getElementById('inadimplencia-detalhes').textContent = 
                    `${ultimoMesLabel}: R$ ${formatBrazilianNumber(ultimoMes)} | ${penultimoMesLabel}: R$ ${formatBrazilianNumber(penultimoMes)}`;
                
                const colorInad = variacaoInad <= 0 ? 'text-green-500' : 'text-red-500';
                document.getElementById('inadimplencia-variacao-highlight-text').className = `text-2xl font-bold cursor-pointer ${colorInad}`;
                document.getElementById('inadimplencia-variacao-text-rec').className = `text-2xl font-bold cursor-pointer ${colorInad}`;
            } else {
                document.getElementById('inadimplencia-detalhes').textContent = 'Dados insuficientes para c√°lculo';
            }
        }

        function updateHistoricoIndices() {
            const table = document.getElementById('historico-table');
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const valorCell = cells[1];
                const totalCell = cells[2];
                const indiceCell = cells[3];
                
                const valor = parseNumber(valorCell.textContent);
                const total = parseNumber(totalCell.textContent);
                
                const indice = total > 0 ? (valor / total * 100) : 0;
                indiceCell.textContent = indice.toFixed(2) + '%';
            });
        }

        function updateCobrancaTotals() {
            const table = document.getElementById('cobranca-table-body');
            if (!table) return;
            
            const rows = table.querySelectorAll('tr:not(.total-row)');
            
            let totalQuantidade = 0;
            let totalValor = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const quantidade = parseInt(cells[1].textContent) || 0;
                    const valor = parseNumber(cells[2].textContent);
                    
                    totalQuantidade += quantidade;
                    totalValor += valor;
                }
            });
            
            // Atualizar linha total
            const totalRow = document.querySelector('.total-row');
            if (totalRow) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 4) {
                    totalCells[1].textContent = totalQuantidade;
                    totalCells[2].textContent = formatBrazilianNumber(totalValor);
                    totalCells[3].textContent = '100%';
                }
            }
            
            // Atualizar percentuais
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const valor = parseNumber(cells[2].textContent);
                    const percentCell = cells[3];
                    const percent = totalValor > 0 ? (valor / totalValor * 100) : 0;
                    percentCell.textContent = percent.toFixed(2) + '%';
                }
            });
        }

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        function saveCompanyName() {
            const companyName = document.getElementById('company-name').textContent;
            localStorage.setItem('companyName', companyName);
        }

        function loadCompanyName() {
            const savedName = localStorage.getItem('companyName');
            if (savedName) {
                document.getElementById('company-name').textContent = savedName;
            }
        }

        function initializeAllCharts() {
            try {
                updateInadimplenciaCharts();
                updateRecuperacaoCharts();
                updateAnaliseCreditoCharts();
                updatePrazoMedioChart();
                updateNotasParceirosChart();
                updateAtrasosAnoChart();
                updateCobrancaChart();
                updateVariationValues();
                updateHistoricoIndices();
                updateCobrancaTotals();
                updateHighlightsCharts();
            } catch (error) {
                console.warn('Erro ao inicializar gr√°ficos:', error);
            }
        }

        function highlightWidget(widgetId) {
            const widget = document.getElementById(widgetId);
            const allWidgets = document.querySelectorAll('[id^="widget-"]');
            
            if (highlightedWidget === widgetId) {
                widget.classList.remove('highlighted-widget');
                allWidgets.forEach(w => w.classList.remove('non-highlighted'));
                highlightedWidget = null;
            } else {
                allWidgets.forEach(w => {
                    w.classList.remove('highlighted-widget', 'non-highlighted');
                });
                
                widget.classList.add('highlighted-widget');
                allWidgets.forEach(w => {
                    if (w.id !== widgetId) {
                        w.classList.add('non-highlighted');
                    }
                });
                highlightedWidget = widgetId;
            }
        }

        function unhighlightWidget(event) {
            if (!event.target.closest('[id^="widget-"]') && !event.target.closest('h2')) {
                const allWidgets = document.querySelectorAll('[id^="widget-"]');
                allWidgets.forEach(w => {
                    w.classList.remove('highlighted-widget', 'non-highlighted');
                });
                highlightedWidget = null;
            }
        }

        function showInfoBox(type) {
            const infoBox = document.getElementById('info-box');
            const infoContent = document.getElementById('info-content');
            
            let content = '';
            
            switch(type) {
                case 'recuperacao':
                    content = `<strong>C√°lculo da Varia√ß√£o de Recupera√ß√£o:</strong><br><br>
                    <strong>Metodologia:</strong> Compara o valor recuperado do √∫ltimo m√™s com o m√™s anterior.<br><br>
                    <strong>F√≥rmula:</strong> ((M√™s Atual - M√™s Anterior) √∑ M√™s Anterior) √ó 100<br><br>
                    <strong>Base de dados:</strong> Tabela "√çndice de Recupera√ß√£o" ‚Üí coluna "Valor Recuperado"<br><br>
                    <strong>Interpreta√ß√£o:</strong><br>
                    ‚Ä¢ Positivo (verde): Melhoria na recupera√ß√£o<br>
                    ‚Ä¢ Negativo (vermelho): Piora na recupera√ß√£o<br><br>
                    <strong>Dados atualizados automaticamente</strong> quando novas planilhas s√£o processadas.`;
                    break;
                case 'inadimplencia':
                    content = `<strong>C√°lculo da Varia√ß√£o de Inadimpl√™ncia:</strong><br><br>
                    <strong>Metodologia:</strong> Compara o total atrasado do √∫ltimo m√™s com o m√™s anterior.<br><br>
                    <strong>F√≥rmula:</strong> ((M√™s Atual - M√™s Anterior) √∑ M√™s Anterior) √ó 100<br><br>
                    <strong>Base de dados:</strong> Tabela "√çndice de Inadimpl√™ncia" ‚Üí coluna "Total Atrasado"<br><br>
                    <strong>Interpreta√ß√£o:</strong><br>
                    ‚Ä¢ Positivo (vermelho): Piora na inadimpl√™ncia<br>
                    ‚Ä¢ Negativo (verde): Melhoria na inadimpl√™ncia<br><br>
                    <strong>Dados atualizados automaticamente</strong> quando novas planilhas s√£o processadas.`;
                    break;
            }
            
            infoContent.innerHTML = content;
            infoBox.classList.add('active');
        }

        function hideInfoBox() {
            const infoBox = document.getElementById('info-box');
            infoBox.classList.remove('active');
        }

        function searchDashboard() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const allElements = document.querySelectorAll('h2, td, th, p, span');
            let foundElements = [];
            
            allElements.forEach(el => {
                el.innerHTML = el.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/g, '$1');
                el.classList.remove('scroll-to-highlight');
            });
            
            if (searchTerm) {
                allElements.forEach(el => {
                    if (el.textContent.toLowerCase().includes(searchTerm)) {
                        foundElements.push(el);
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        el.innerHTML = el.innerHTML.replace(regex, '<span class="highlight">$1</span>');
                    }
                });
                
                if (foundElements.length > 0) {
                    foundElements[0].classList.add('scroll-to-highlight');
                    foundElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    setTimeout(() => {
                        foundElements[0].classList.remove('scroll-to-highlight');
                    }, 2000);
                }
            }
        }

        function formatBrazilianNumber(value) {
            if (typeof value !== 'number') {
                value = parseFloat(value) || 0;
            }
            return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function parseNumber(str) {
            if (typeof str === 'string') {
                return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return parseFloat(str) || 0;
        }

        function handleManualEdit(cell) {
            cell.classList.add('manual-edit');
        }

        // ========== FUN√á√ïES DA TABELA RENEGOCIAR ==========
        function parseNumberBR(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return parseFloat(value) || 0;
        }

        function formatNumberBR(value) {
            return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function initRenegociarTable() {
            const tbody = document.getElementById('renegociar-table-body-detalhado');
            tbody.innerHTML = '';
            
            const savedData = localStorage.getItem('dashboardData');
            if (savedData) {
                const data = JSON.parse(savedData);
                if (data.renegociarLines && data.renegociarLines.length > 0) {
                    data.renegociarLines.forEach(lineData => {
                        addRenegociarLinha(lineData);
                    });
                } else {
                    addRenegociarLinha({
                        parcela: '100,00',
                        multa: '15,00',
                        vencimento: '31/03/2025',
                        atraso: '126',
                        juros: '126,00',
                        subtotal: '241,00',
                        nota: 'Parcela em atraso',
                        custas: '0,00'
                    });
                }
            } else {
                addRenegociarLinha({
                    parcela: '100,00',
                    multa: '15,00',
                    vencimento: '31/03/2025',
                    atraso: '126',
                    juros: '126,00',
                    subtotal: '241,00',
                    nota: 'Parcela em atraso',
                    custas: '0,00'
                });
            }
            
            updateDetailedStatistics();
        }

        function initRenegociarTableFromData(renegociarLines) {
            const tbody = document.getElementById('renegociar-table-body-detalhado');
            tbody.innerHTML = '';
            
            if (renegociarLines && renegociarLines.length > 0) {
                renegociarLines.forEach(lineData => {
                    addRenegociarLinha(lineData);
                });
            } else {
                addRenegociarLinha({
                    parcela: '100,00',
                    multa: '15,00',
                    vencimento: '31/03/2025',
                    atraso: '126',
                    juros: '126,00',
                    subtotal: '241,00',
                    nota: 'Parcela em atraso',
                    custas: '0,00'
                });
            }
            
            updateDetailedStatistics();
        }

        function addRenegociarLinha(lineData = null) {
            const tbody = document.getElementById('renegociar-table-body-detalhado');
            const rows = tbody.getElementsByTagName('tr');
            
            if (!lineData && rows.length > 0) {
                const lastRow = rows[rows.length - 1];
                const lastCells = lastRow.querySelectorAll('td');
                
                const lastParcela = lastCells[0]?.textContent || '100,00';
                const lastVencimento = lastCells[2]?.textContent || '31/03/2025';
                const lastNota = lastCells[6]?.textContent || 'Parcela em atraso';
                const lastCustas = lastCells[7]?.textContent || '0,00';
                
                let nextVencimento = lastVencimento;
                if (lastVencimento && lastVencimento !== 'DD/MM/AAAA') {
                    const [day, month, year] = lastVencimento.split('/').map(Number);
                    let nextDate = new Date(year, month - 1, day);
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    
                    const daysInMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                    const adjustedDay = Math.min(day, daysInMonth);
                    nextDate.setDate(adjustedDay);
                    
                    const nextDay = nextDate.getDate().toString().padStart(2, '0');
                    const nextMonth = (nextDate.getMonth() + 1).toString().padStart(2, '0');
                    const nextYear = nextDate.getFullYear();
                    nextVencimento = `${nextDay}/${nextMonth}/${nextYear}`;
                }
                
                lineData = {
                    parcela: lastParcela,
                    multa: '0,00',
                    vencimento: nextVencimento,
                    atraso: '0',
                    juros: '0,00',
                    subtotal: '0,00',
                    nota: lastNota,
                    custas: lastCustas
                };
            }
            
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-600 hover:bg-gray-700';
            tr.innerHTML = `
                <td contenteditable="true" class="p-2 update-reneg-detalhado" onclick="handleCellClick(this, event)">${lineData.parcela}</td>
                <td class="p-2" onclick="handleCellClick(this, event)">${lineData.multa}</td>
                <td contenteditable="true" class="p-2 update-reneg-detalhado" onclick="handleCellClick(this, event)">${lineData.vencimento}</td>
                <td class="p-2" onclick="handleCellClick(this, event)">${lineData.atraso}</td>
                <td class="p-2" onclick="handleCellClick(this, event)">${lineData.juros}</td>
                <td class="p-2" onclick="handleCellClick(this, event)">${lineData.subtotal}</td>
                <td contenteditable="true" class="p-2 update-reneg-detalhado" onclick="handleCellClick(this, event)">${lineData.nota}</td>
                <td contenteditable="true" class="p-2 update-reneg-detalhado" onclick="handleCellClick(this, event)">${lineData.custas}</td>`;
            
            tbody.appendChild(tr);
            
            tr.querySelectorAll('.update-reneg-detalhado').forEach(cell => {
                cell.addEventListener('blur', function() {
                    updateDetailedReneg(this);
                    saveDataToLocalStorage();
                });
            });
            
            updateDetailedReneg(tr.querySelector('.update-reneg-detalhado'));
            saveDataToLocalStorage();
        }

        function updateDetailedReneg(cell) {
            const row = cell.parentElement;
            const cells = row.getElementsByTagName('td');
            
            const parcela = parseNumberBR(cells[0].textContent);
            const vencimento = cells[2].textContent;
            
            const multa = parcela * 0.15;
            cells[1].textContent = formatNumberBR(multa);
            
            let atraso = 0;
            if (vencimento && vencimento !== 'DD/MM/AAAA') {
                const vencParts = vencimento.split('/');
                if (vencParts.length === 3) {
                    const vencDate = new Date(`${vencParts[2]}-${vencParts[1]}-${vencParts[0]}`);
                    const hoje = new Date();
                    if (!isNaN(vencDate.getTime()) && vencDate < hoje) {
                        atraso = Math.floor((hoje - vencDate) / (1000 * 60 * 60 * 24));
                    }
                }
            }
            cells[3].textContent = atraso;
            
            const mesesAtraso = Math.ceil(atraso / 30);
            const juros = parcela * (mesesAtraso * 0.01);
            cells[4].textContent = formatNumberBR(juros);
            
            const desconto = parseNumberBR(cells[7].textContent);
            const subtotal = parcela + multa + juros - desconto;
            cells[5].textContent = formatNumberBR(subtotal);
            
            updateDetailedStatistics();
        }

        function updateDetailedStatistics() {
            const rows = document.querySelectorAll('#renegociar-table-body-detalhado tr');
            const statisticsDiv = document.getElementById('detailed-statistics');
            const removeBtn = document.getElementById('remove-row-btn');
            
            if (rows.length <= 1) {
                removeBtn.disabled = true;
                removeBtn.classList.add('opacity-50');
                removeBtn.classList.remove('hover:bg-red-700');
            } else {
                removeBtn.disabled = false;
                removeBtn.classList.remove('opacity-50');
                removeBtn.classList.add('hover:bg-red-700');
            }
            
            if (rows.length > 0) {
                let somaParcela = 0;
                let somaMulta = 0;
                let somaSubtotal = 0;
                let maiorAtraso = 0;
                let somaVencimentos = 0;
                let vencimentosValidos = 0;
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        const parcela = parseNumberBR(cells[0].textContent);
                        const multa = parseNumberBR(cells[1].textContent);
                        const vencimento = cells[2].textContent;
                        const atraso = parseInt(cells[3].textContent) || 0;
                        const subtotal = parseNumberBR(cells[5].textContent);
                        
                        somaParcela += parcela;
                        somaMulta += multa;
                        somaSubtotal += subtotal;
                        maiorAtraso = Math.max(maiorAtraso, atraso);
                        
                        const vencParts = vencimento.split('/');
                        if(vencParts.length === 3 && vencimento !== 'DD/MM/AAAA'){
                            const vencDate = new Date(`${vencParts[2]}-${vencParts[1]}-${vencParts[0]}`);
                            if(!isNaN(vencDate.getTime())){
                                somaVencimentos += vencDate.getTime();
                                vencimentosValidos++;
                            }
                        }
                    }
                });
                
                let mediaVencimento = 'N/A';
                if(vencimentosValidos > 0){
                    const mediaTimestamp = somaVencimentos / vencimentosValidos;
                    const mediaDate = new Date(mediaTimestamp);
                    mediaVencimento = `${mediaDate.getDate().toString().padStart(2, '0')}/${(mediaDate.getMonth() + 1).toString().padStart(2, '0')}/${mediaDate.getFullYear()}`;
                }
                
                const discount = parseFloat(document.getElementById('discount-input').value) || 0;
                const subtotalComDesconto = somaSubtotal * (1 - (discount / 100));
                
                statisticsDiv.innerHTML = `
                    <h3 class="text-sm font-semibold mb-2 text-blue-300">Estat√≠sticas (${rows.length} parcelas) - desconto ${discount}%</h3>
                    <div class="grid grid-cols-5 gap-2 text-xs">
                        <div>
                            <span class="text-gray-400">Soma Parcelas:</span><br>
                            <span class="text-green-400 font-medium">R$ ${formatNumberBR(somaParcela)}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Soma Multas:</span><br>
                            <span class="text-yellow-400 font-medium">R$ ${formatNumberBR(somaMulta)}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">M√©dia Vencimento:</span><br>
                            <span class="text-blue-400 font-medium">${mediaVencimento}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Maior Atraso:</span><br>
                            <span class="text-red-400 font-medium">${maiorAtraso} dias</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Soma Subtotal:</span><br>
                            <span class="text-green-400 font-medium font-bold">R$ ${formatNumberBR(subtotalComDesconto)}</span>
                        </div>
                    </div>
                `;
                statisticsDiv.style.display = 'block';
            }
        }

        function addDetailedRow(){
            addRenegociarLinha(null);
        }

        function removeDetailedRow(){
            const tbody = document.getElementById('renegociar-table-body-detalhado');
            const rows = tbody.getElementsByTagName('tr');
            
            if(rows.length > 1) {
                tbody.removeChild(rows[rows.length - 1]);
                updateDetailedStatistics();
                saveDataToLocalStorage();
            } else {
                alert('N√£o √© poss√≠vel excluir todas as linhas. √â necess√°rio manter pelo menos 1 linha na tabela.');
            }
        }

        function searchRenegociar() {
            const searchTerm = document.getElementById('search-renegociar').value.toLowerCase();
            const rows = document.querySelectorAll('#renegociar-table-body-detalhado tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let found = false;
                
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                    }
                });
                
                if (found) {
                    row.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    row.style.backgroundColor = '';
                }
            });
        }

        // ========== FUN√á√ïES DE SELE√á√ÉO DE C√âLULAS ==========
        function initSelectionTools() {
            const table = document.getElementById('renegociar-table');
            if (!table) return;
            
            table.addEventListener('mousedown', handleMouseDown);
            table.addEventListener('mouseup', handleMouseUp);
            table.addEventListener('mousemove', handleMouseMove);
            
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            table.addEventListener('touchstart', handleTouchStart);
            table.addEventListener('touchend', handleTouchEnd);
        }

        function handleCellClick(cell, event) {
            const isCtrlPressed = event.ctrlKey || event.metaKey;
            
            if (isCtrlPressed) {
                toggleCellSelection(cell);
            } else {
                if (!selectedCells.has(cell)) {
                    clearSelection();
                    selectCell(cell);
                }
            }
            
            updateCopyTools();
        }

        function handleMouseDown(event) {
            const cell = event.target.closest('td');
            if (!cell || !cell.closest('#renegociar-table-body-detalhado')) return;
            
            isSelecting = true;
            startCell = cell;
            
            if (!event.ctrlKey && !event.metaKey) {
                clearSelection();
            }
            
            selectCell(cell);
        }

        function handleMouseMove(event) {
            if (!isSelecting) return;
            
            const cell = event.target.closest('td');
            if (!cell || !cell.closest('#renegociar-table-body-detalhado')) return;
            
            selectRange(startCell, cell);
        }

        function handleMouseUp() {
            isSelecting = false;
            updateCopyTools();
        }

        function handleTouchStart(event) {
            const touch = event.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            const cell = element.closest('td');
            
            if (cell && cell.closest('#renegociar-table-body-detalhado')) {
                toggleCellSelection(cell);
                updateCopyTools();
            }
        }

        function handleTouchEnd() {
            updateCopyTools();
        }

        function handleKeyDown(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key.toLowerCase()) {
                    case 'c':
                        event.preventDefault();
                        copySelectedValues();
                        break;
                    case 'a':
                        event.preventDefault();
                        selectAllCells();
                        break;
                }
            }
        }

        function handleKeyUp(event) {
            if (event.key === 'Control' || event.key === 'Meta') {
                updateCopyTools();
            }
        }

        function selectCell(cell) {
            selectedCells.add(cell);
            cell.classList.add('selected-cell');
        }

        function toggleCellSelection(cell) {
            if (selectedCells.has(cell)) {
                selectedCells.delete(cell);
                cell.classList.remove('selected-cell');
            } else {
                selectedCells.add(cell);
                cell.classList.add('selected-cell');
            }
        }

        function selectRange(startCell, endCell) {
            const table = document.getElementById('renegociar-table');
            const rows = table.querySelectorAll('#renegociar-table-body-detalhado tr');
            
            if (!startCell || !endCell) return;
            
            const startRow = startCell.parentElement.rowIndex;
            const startCol = startCell.cellIndex;
            const endRow = endCell.parentElement.rowIndex;
            const endCol = endCell.cellIndex;
            
            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);
            
            clearSelection();
            
            for (let i = minRow; i <= maxRow; i++) {
                const row = rows[i];
                if (!row) continue;
                
                for (let j = minCol; j <= maxCol; j++) {
                    const cell = row.cells[j];
                    if (cell) {
                        selectCell(cell);
                    }
                }
            }
        }

        function selectAllCells() {
            const cells = document.querySelectorAll('#renegociar-table-body-detalhado td');
            clearSelection();
            cells.forEach(cell => selectCell(cell));
            updateCopyTools();
        }

        function selectAllInColumn(columnIndex) {
            const rows = document.querySelectorAll('#renegociar-table-body-detalhado tr');
            clearSelection();
            
            rows.forEach(row => {
                const cell = row.cells[columnIndex];
                if (cell) {
                    selectCell(cell);
                }
            });
            
            updateCopyTools();
        }

        function clearSelection() {
            selectedCells.forEach(cell => {
                cell.classList.remove('selected-cell');
            });
            selectedCells.clear();
            updateCopyTools();
        }

        function updateCopyTools() {
            const copyTools = document.getElementById('copy-tools');
            if (selectedCells.size > 0) {
                copyTools.classList.add('active');
            } else {
                copyTools.classList.remove('active');
            }
        }

        function copySelectedValues() {
            if (selectedCells.size === 0) return;
            
            let values = [];
            let lastRow = -1;
            
            const sortedCells = Array.from(selectedCells).sort((a, b) => {
                const rowDiff = a.parentElement.rowIndex - b.parentElement.rowIndex;
                if (rowDiff !== 0) return rowDiff;
                return a.cellIndex - b.cellIndex;
            });
            
            sortedCells.forEach(cell => {
                const currentRow = cell.parentElement.rowIndex;
                
                if (currentRow !== lastRow && lastRow !== -1) {
                    values.push('\n');
                }
                
                values.push(cell.textContent.trim());
                
                if (sortedCells.indexOf(cell) < sortedCells.length - 1) {
                    const nextCell = sortedCells[sortedCells.indexOf(cell) + 1];
                    if (nextCell.parentElement.rowIndex === currentRow) {
                        values.push('\t');
                    }
                }
                
                lastRow = currentRow;
            });
            
            const textToCopy = values.join('');
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    console.log('Valores copiados:', textToCopy);
                    alert(`${selectedCells.size} valores copiados para a √°rea de transfer√™ncia!`);
                })
                .catch(err => {
                    console.error('Erro ao copiar:', err);
                    alert('Erro ao copiar valores. Tente novamente.');
                });
        }

        function copyColumnValues() {
            if (selectedCells.size === 0) return;
            
            const firstCell = Array.from(selectedCells)[0];
            const columnIndex = firstCell.cellIndex;
            
            selectAllInColumn(columnIndex);
            copySelectedValues();
        }

        // ========== FUN√á√ïES DE PLANILHAS ==========
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length) {
                const input = document.getElementById('fileInput');
                input.files = files;
                handleFileSelect({ target: input });
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                uploadedFiles.push({
                    name: file.name,
                    file: file
                });
                
                const fileList = document.getElementById('uploadedFiles');
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${file.name}</span>
                    <button onclick="removeFile('${file.name}')" class="text-red-500">√ó</button>
                `;
                fileList.appendChild(fileItem);
                
                const select = document.getElementById('selectedFile');
                const option = document.createElement('option');
                option.value = file.name;
                option.textContent = file.name;
                select.appendChild(option);
            }
            
            event.target.value = '';
        }

        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
            
            const fileList = document.getElementById('uploadedFiles');
            const items = fileList.querySelectorAll('.file-item');
            items.forEach(item => {
                if (item.querySelector('span').textContent === fileName) {
                    item.remove();
                }
            });
            
            const select = document.getElementById('selectedFile');
            const options = select.querySelectorAll('option');
            options.forEach(option => {
                if (option.value === fileName) {
                    option.remove();
                }
            });
        }

        function updateProcessingOptions() {
            const dataType = document.getElementById('dataType').value;
            const pagamentosConfig = document.getElementById('pagamentosConfig');
            const atrasadosConfig = document.getElementById('atrasadosConfig');
            
            pagamentosConfig.style.display = 'none';
            atrasadosConfig.style.display = 'none';
            
            if (dataType === 'pagamentos') {
                pagamentosConfig.style.display = 'block';
            } else if (dataType === 'atrasados') {
                atrasadosConfig.style.display = 'block';
            }
        }

        function processSpreadsheet() {
            const selectedFile = document.getElementById('selectedFile').value;
            const dataType = document.getElementById('dataType').value;
            
            if (!selectedFile) {
                alert('Selecione um arquivo primeiro.');
                return;
            }
            
            if (!dataType) {
                alert('Selecione um tipo de dados.');
                return;
            }
            
            const file = uploadedFiles.find(f => f.name === selectedFile);
            if (!file) {
                alert('Arquivo n√£o encontrado.');
                return;
            }
            
            if (dataType === 'pagamentos') {
                const columnMap = {
                    nroNota: document.getElementById('pagamentosNroNota').value.trim(),
                    nomeParceiro: document.getElementById('pagamentosNomeParceiro').value.trim(),
                    vlrDesdobramento: document.getElementById('pagamentosVlrDesdobramento').value.trim(),
                    vlrJuros: document.getElementById('pagamentosVlrJuros').value.trim(),
                    vlrBaixa: document.getElementById('pagamentosVlrBaixa').value.trim(),
                    dtVencimento: document.getElementById('pagamentosDtVencimento').value.trim(),
                    dataBaixa: document.getElementById('pagamentosDataBaixa').value.trim(),
                    nomeFantasia: document.getElementById('pagamentosNomeFantasia').value.trim(),
                    descricao: document.getElementById('pagamentosDescricao').value.trim(),
                    nsu: document.getElementById('pagamentosNSU').value.trim(),
                    desdob: document.getElementById('pagamentosDesdob').value.trim(),
                    apelido: document.getElementById('pagamentosApelido').value.trim(),
                    historico: document.getElementById('pagamentosHistorico').value.trim(),
                    dtNegociacao: document.getElementById('pagamentosDtNegociacao').value.trim()
                };
                
                const camposEssenciais = ['nomeParceiro', 'vlrBaixa', 'dtVencimento', 'dataBaixa'];
                const camposVazios = camposEssenciais.filter(campo => !columnMap[campo]);
                
                if (camposVazios.length > 0) {
                    alert(`Por favor, preencha os seguintes campos essenciais: ${camposVazios.join(', ')}`);
                    return;
                }
                
                processPagamentosSpreadsheet(file.file, columnMap);
            } else if (dataType === 'atrasados') {
                const columnMap = {
                    nroUnico: document.getElementById('atrasadosNroUnico').value.trim(),
                    cnpjCpf: document.getElementById('atrasadosCnpjCpf').value.trim(),
                    codParceiro: document.getElementById('atrasadosCodParceiro').value.trim(),
                    parceiro: document.getElementById('atrasadosParceiro').value.trim(),
                    telefone: document.getElementById('atrasadosTelefone').value.trim(),
                    desdob: document.getElementById('atrasadosDesdob').value.trim(),
                    email: document.getElementById('atrasadosEmail').value.trim(),
                    codNatureza: document.getElementById('atrasadosCodNatureza').value.trim(),
                    natureza: document.getElementById('atrasadosNatureza').value.trim(),
                    nroNota: document.getElementById('atrasadosNroNota').value.trim(),
                    dataEmissao: document.getElementById('atrasadosDataEmissao').value.trim(),
                    dataVencimento: document.getElementById('atrasadosDataVencimento').value.trim(),
                    diasAtraso: document.getElementById('atrasadosDiasAtraso').value.trim(),
                    codTipoTitulo: document.getElementById('atrasadosCodTipoTitulo').value.trim(),
                    tipoTitulo: document.getElementById('atrasadosTipoTitulo').value.trim(),
                    codTipoNegociacao: document.getElementById('atrasadosCodTipoNegociacao').value.trim(),
                    tipoNegociacao: document.getElementById('atrasadosTipoNegociacao').value.trim(),
                    observacao: document.getElementById('atrasadosObservacao').value.trim(),
                    valor: document.getElementById('atrasadosValor').value.trim()
                };
                
                const camposEssenciais = ['parceiro', 'valor', 'dataVencimento'];
                const camposVazios = camposEssenciais.filter(campo => !columnMap[campo]);
                
                if (camposVazios.length > 0) {
                    alert(`Por favor, preencha os seguintes campos essenciais: ${camposVazios.join(', ')}`);
                    return;
                }
                
                processAtrasadosSpreadsheet(file.file, columnMap);
            } else {
                alert('Processamento para outros tipos de dados ser√° implementado em breve.');
            }
        }

        function processPagamentosSpreadsheet(file, columnMap) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processarDadosPagamentos(jsonData, columnMap);
                } catch (error) {
                    console.error('Erro ao processar planilha:', error);
                    alert('Erro ao processar a planilha. Verifique se o arquivo est√° no formato correto.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processAtrasadosSpreadsheet(file, columnMap) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    processarDadosAtrasados(jsonData, columnMap);
                } catch (error) {
                    console.error('Erro ao processar planilha:', error);
                    alert('Erro ao processar a planilha. Verifique se o arquivo est√° no formato correto.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function parseExcelDate(dateString) {
            if (!dateString || dateString === 'N/A') return null;
            
            if (!isNaN(dateString) && dateString.toString().trim() !== '' && dateString.toString().indexOf('/') === -1 && dateString.toString().indexOf('-') === -1) {
                const excelSerial = parseFloat(dateString);
                if (excelSerial > 0) {
                    const excelBaseDate = new Date(1899, 11, 30);
                    const days = Math.floor(excelSerial);
                    const milliseconds = (excelSerial - days) * 86400000;
                    const resultDate = new Date(excelBaseDate.getTime() + days * 86400000 + milliseconds);
                    
                    if (!isNaN(resultDate.getTime()) && resultDate.getFullYear() > 1900) {
                        return resultDate;
                    }
                }
            }
            
            const dateStr = dateString.toString().trim();
            
            const partsSlash = dateStr.split('/');
            if (partsSlash.length === 3) {
                let day = parseInt(partsSlash[0], 10);
                let month = parseInt(partsSlash[1], 10) - 1;
                let year = parseInt(partsSlash[2], 10);
                
                if (year < 100) {
                    if (year < 50) {
                        year += 2000;
                    } else {
                        year += 1900;
                    }
                }
                
                if (!isNaN(day) && !isNaN(month) && !isNaN(year) && day >= 1 && day <= 31 && month >= 0 && month <= 11) {
                    const date = new Date(year, month, day);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
            }
            
            const partsDash = dateStr.split('-');
            if (partsDash.length === 3) {
                let day, month, year;
                
                if (partsDash[0].length <= 2 && partsDash[1].length <= 2) {
                    day = parseInt(partsDash[0], 10);
                    month = parseInt(partsDash[1], 10) - 1;
                    year = parseInt(partsDash[2], 10);
                } else if (partsDash[0].length === 4) {
                    year = parseInt(partsDash[0], 10);
                    month = parseInt(partsDash[1], 10) - 1;
                    day = parseInt(partsDash[2], 10);
                }
                
                if (year !== undefined) {
                    if (year < 100) {
                        if (year < 50) {
                            year += 2000;
                        } else {
                            year += 1900;
                        }
                    }
                    
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year) && day >= 1 && day <= 31 && month >= 0 && month <= 11) {
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
            }
            
            const nativeDate = new Date(dateStr);
            if (!isNaN(nativeDate.getTime())) {
                return nativeDate;
            }
            
            console.warn(`N√£o foi poss√≠vel parsear a data: "${dateString}"`);
            return null;
        }

        function formatDateBR(date) {
            if (!date) return 'N/A';
            if (typeof date === 'string') {
                const parsed = parseExcelDate(date);
                if (!parsed) return date;
                date = parsed;
            }
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        function categorizarPagamentoComTolerancia(diasAtraso, tolerancia) {
            if (diasAtraso <= tolerancia) {
                return 'Recebidos dentro do prazo';
            } else if (diasAtraso >= 1 && diasAtraso <= 15) {
                return 'Recebidos de 01 √† 15 dias';
            } else if (diasAtraso >= 16 && diasAtraso <= 30) {
                return 'Recebidos de 16 √† 30 dias';
            } else if (diasAtraso >= 31 && diasAtraso <= 90) {
                return 'Recebidos de 31 √† 90 dias';
            } else {
                return 'Recebidos acima 91 dias';
            }
        }

        function atualizarCategorizacaoPagamentos() {
            if (pagamentosRawData.length === 0) return;
            
            const tolerancia = parseInt(document.getElementById('toleranciaDias').value) || 2;
            
            pagamentosRawData.forEach(pagamento => {
                let diasAtraso = 0;
                if (pagamento.vencimento && pagamento.dataBaixa) {
                    const vencDate = parseExcelDate(pagamento.vencimento);
                    const baixaDate = parseExcelDate(pagamento.dataBaixa);
                    
                    if (vencDate && baixaDate) {
                        diasAtraso = Math.floor((baixaDate - vencDate) / (1000 * 60 * 60 * 24));
                    }
                }
                
                pagamento.categoria = categorizarPagamentoComTolerancia(diasAtraso, tolerancia);
            });
            
            const pagamentosPorMes = {};
            const categorias = [
                'Recebidos dentro do prazo',
                'Recebidos de 01 √† 15 dias',
                'Recebidos de 16 √† 30 dias',
                'Recebidos de 31 √† 90 dias',
                'Recebidos acima 91 dias'
            ];
            
            const pagamentosComMesValido = pagamentosRawData.filter(p => p.mesAno !== 'Desconhecido');
            
            pagamentosComMesValido.forEach(p => {
                if (!pagamentosPorMes[p.mesAno]) {
                    pagamentosPorMes[p.mesAno] = {};
                    categorias.forEach(cat => {
                        pagamentosPorMes[p.mesAno][cat] = { quantidade: 0, valor: 0 };
                    });
                }
                
                pagamentosPorMes[p.mesAno][p.categoria].quantidade += 1;
                pagamentosPorMes[p.mesAno][p.categoria].valor += p.valorLiquido;
            });
            
            pagamentosProcessados = pagamentosPorMes;
            gerarTabelasPagamentosMultiplos(pagamentosPorMes);
            saveDataToLocalStorage();
        }

        function calcularDataPorNumeroParcela(dataBase, numeroParcela, diasEntreParcelas = 30) {
            if (!dataBase || !numeroParcela) return null;
            
            const data = parseExcelDate(dataBase);
            if (!data) return null;
            
            const dataEstimada = new Date(data);
            dataEstimada.setDate(dataEstimada.getDate() + (numeroParcela * diasEntreParcelas));
            
            return dataEstimada;
        }

        function calcularDataPorTotalParcelas(dataBase, numeroParcela, totalParcelas, diasEntreParcelas = 30) {
            if (!dataBase || !numeroParcela || !totalParcelas) return null;
            
            const data = parseExcelDate(dataBase);
            if (!data) return null;
            
            const dataEstimada = new Date(data);
            dataEstimada.setDate(dataEstimada.getDate() + (numeroParcela * diasEntreParcelas));
            
            return dataEstimada;
        }

        function exibirDetecaoAlteracoes(resultadoDetecao) {
            const section = document.getElementById('alteracoesSection');
            const body = document.getElementById('alteracoesBody');
            
            if (!section || !body) return;
            
            if (resultadoDetecao.totalAlteracoes === 0) {
                section.style.display = 'none';
                return;
            }
            
            document.getElementById('totalAlteracoes').textContent = resultadoDetecao.totalAlteracoes;
            document.getElementById('mediaDiferenca').textContent = resultadoDetecao.mediaDiferenca;
            document.getElementById('clientesAfetados').textContent = resultadoDetecao.clientesAfetados;
            
            body.innerHTML = '';
            
            resultadoDetecao.alteracoes.forEach(alteracao => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700 hover:bg-gray-800';
                tr.innerHTML = `
                    <td class="p-2 font-medium">${alteracao.cliente}</td>
                    <td class="p-2">${alteracao.parcela}/${alteracao.totalParcelas}</td>
                    <td class="p-2">${alteracao.vencimentoEstimado}</td>
                    <td class="p-2">${alteracao.vencimentoReal}</td>
                    <td class="p-2 ${alteracao.diferencaDias > 0 ? 'text-red-400' : 'text-green-400'}">
                        ${alteracao.diferencaDias > 0 ? '+' : ''}${alteracao.diferencaDias} dias
                    </td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${
                            alteracao.probabilidade === 'alta' ? 'bg-red-500' :
                            alteracao.probabilidade === 'media' ? 'bg-yellow-500' : 'bg-blue-500'
                        }">
                            ${alteracao.probabilidade.toUpperCase()}
                        </span>
                    </td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${
                            alteracao.statusPagamento === 'Pago em atraso' ? 'bg-red-500' :
                            alteracao.statusPagamento === 'Dentro do prazo' ? 'bg-green-500' : 'bg-yellow-500'
                        }">
                            ${alteracao.statusPagamento}
                        </span>
                    </td>
                    <td class="p-2 text-xs">${alteracao.metodoCalculo}</td>
                `;
                body.appendChild(tr);
            });
            
            section.style.display = 'block';
        }

        function recalcularDetecao() {
            if (pagamentosRawData.length === 0) {
                alert('Nenhum dado processado para recalcular. Processe uma planilha primeiro.');
                return;
            }
            
            const diasEntreParcelas = parseInt(document.getElementById('diasEntreParcelas').value) || 30;
            const toleranciaDias = parseInt(document.getElementById('toleranciaDias').value) || 2;
            
            const resultadoDetecao = detectarAlteracoesVencimentoAtualizada(pagamentosRawData, diasEntreParcelas, toleranciaDias);
            
            exibirDetecaoAlteracoes(resultadoDetecao);
            atualizarParcelasMonitoradas(resultadoDetecao.alteracoes);
            atualizarCategorizacaoPagamentos();
            
            saveDataToLocalStorage();
            
            alert(`Rec√°lculo conclu√≠do!\n${resultadoDetecao.totalAlteracoes} parcelas monitoradas.\nCategoriza√ß√£o atualizada com toler√¢ncia de ${toleranciaDias} dias.`);
        }

        function atualizarParcelasMonitoradas(alteracoes) {
            parcelasMonitoradas = alteracoes;
            atualizarListaParcelasVisualMultiplo(Array.from(filtrosSelecionados));
        }

        function showResultsPanel(pagamentos) {
            const resultsPanel = document.getElementById('resultsPanel');
            const processedDataBody = document.getElementById('processedDataBody');
            
            if (!resultsPanel || !processedDataBody) return;
            
            resultsPanel.style.display = 'block';
            
            const totalRecords = pagamentos.length;
            const totalValue = pagamentos.reduce((sum, p) => sum + p.valorLiquido, 0);
            const avgValue = totalRecords > 0 ? totalValue / totalRecords : 0;
            const mesesCount = Object.keys(pagamentosProcessados).length;
            
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalValue').textContent = `R$ ${formatBrazilianNumber(totalValue)}`;
            document.getElementById('avgValue').textContent = `R$ ${formatBrazilianNumber(avgValue)}`;
            document.getElementById('monthsCount').textContent = mesesCount;
            
            processedDataBody.innerHTML = '';
            
            Object.keys(pagamentosProcessados).sort().forEach(mes => {
                const data = pagamentosProcessados[mes];
                const totalQuantidade = Object.values(data).reduce((sum, cat) => sum + cat.quantidade, 0);
                const totalValor = Object.values(data).reduce((sum, cat) => sum + cat.valor, 0);
                
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-600';
                row.innerHTML = `
                    <td class="p-2">${mes}</td>
                    <td class="p-2">R$ ${formatBrazilianNumber(totalValor)}</td>
                    <td class="p-2">${totalQuantidade}</td>
                    <td class="p-2">
                        <button onclick="exportMonthData('${mes}')" class="text-blue-400 hover:text-blue-300">Exportar</button>
                    </td>
                `;
                processedDataBody.appendChild(row);
            });
        }

        function previewData() {
            alert('Visualiza√ß√£o de dados ser√° implementada em breve.');
        }

        function exportToConfig() {
            alert('Exporta√ß√£o para configura√ß√µes ser√° implementada em breve.');
        }

        function downloadProcessed() {
            alert('Download de dados processados ser√° implementado em breve.');
        }

        function exportMonthData(mes) {
            alert(`Exporta√ß√£o do m√™s ${mes} ser√° implementada em breve.`);
        }

        function processarDadosPagamentos(data, columnMap) {
            const headers = data[0];
            const columnIndex = {};
            
            function columnLetterToIndex(letter) {
                let column = 0;
                letter = letter.toUpperCase().trim();
                for (let i = 0; i < letter.length; i++) {
                    column = column * 26 + (letter.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
                }
                return column - 1;
            }
            
            function normalizeColumnName(name) {
                if (!name) return '';
                return name.toString().trim().toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, ' ')
                    .replace(/[^\w\s]/gi, '');
            }
            
            for (let key in columnMap) {
                const columnSpec = columnMap[key].toString().trim();
                let index = -1;
                
                if (!columnSpec) {
                    columnIndex[key] = -1;
                    continue;
                }
                
                if (/^[A-Z]+$/i.test(columnSpec)) {
                    index = columnLetterToIndex(columnSpec);
                } 
                else if (/^\d+$/.test(columnSpec)) {
                    index = parseInt(columnSpec) - 1;
                }
                else {
                    const normalizedSpec = normalizeColumnName(columnSpec);
                    for (let i = 0; i < headers.length; i++) {
                        if (headers[i]) {
                            const normalizedHeader = normalizeColumnName(headers[i]);
                            if (normalizedHeader === normalizedSpec) {
                                index = i;
                                break;
                            }
                        }
                    }
                    
                    if (index === -1) {
                        for (let i = 0; i < headers.length; i++) {
                            if (headers[i]) {
                                const normalizedHeader = normalizeColumnName(headers[i]);
                                if (normalizedHeader.includes(normalizedSpec) || normalizedSpec.includes(normalizedHeader)) {
                                    index = i;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                columnIndex[key] = index;
            }
            
            const colunasRequisitadas = ['nomeParceiro', 'vlrBaixa', 'dtVencimento', 'dataBaixa'];
            let colunasFaltantes = [];
            let mensagemErro = '';
            
            for (let coluna of colunasRequisitadas) {
                if (columnIndex[coluna] === undefined || columnIndex[coluna] < 0) {
                    const nomeColuna = columnMap[coluna] || coluna;
                    colunasFaltantes.push(nomeColuna);
                }
            }
            
            if (colunasFaltantes.length > 0) {
                mensagemErro = `As seguintes colunas n√£o foram encontradas: ${colunasFaltantes.join(', ')}\n\n`;
                mensagemErro += `Colunas dispon√≠veis na planilha:\n`;
                
                for (let i = 0; i < headers.length; i++) {
                    const letraColuna = String.fromCharCode(65 + (i % 26)) + (i >= 26 ? String.fromCharCode(64 + Math.floor(i / 26)) : '');
                    const nomeColuna = headers[i] || `(Coluna ${letraColuna} - sem nome)`;
                    mensagemErro += `${letraColuna}: ${nomeColuna}\n`;
                }
                
                alert(mensagemErro);
                return;
            }
            
            const pagamentos = [];
            pagamentosRawData = [];
            
            const tolerancia = parseInt(document.getElementById('toleranciaDias').value) || 2;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                const nomeParceiro = row[columnIndex.nomeParceiro] ? row[columnIndex.nomeParceiro].toString().trim() : '';
                const vlrBaixa = parseNumber(row[columnIndex.vlrBaixa] || '0');
                const dtVencimento = row[columnIndex.dtVencimento] ? row[columnIndex.dtVencimento].toString().trim() : '';
                const dataBaixa = row[columnIndex.dataBaixa] ? row[columnIndex.dataBaixa].toString().trim() : '';
                const dtNegociacao = row[columnIndex.dtNegociacao] ? row[columnIndex.dtNegociacao].toString().trim() : '';
                const nroNota = row[columnIndex.nroNota] ? row[columnIndex.nroNota].toString().trim() : '';
                const nomeFantasia = row[columnIndex.nomeFantasia] ? row[columnIndex.nomeFantasia].toString().trim() : '';
                const descricao = row[columnIndex.descricao] ? row[columnIndex.descricao].toString().trim() : '';
                const nsu = row[columnIndex.nsu] ? row[columnIndex.nsu].toString().trim() : '';
                const desdob = row[columnIndex.desdob] ? row[columnIndex.desdob].toString().trim() : '';
                const apelido = row[columnIndex.apelido] ? row[columnIndex.apelido].toString().trim() : '';
                const historico = row[columnIndex.historico] ? row[columnIndex.historico].toString().trim() : '';
                const vlrDesdobramento = parseNumber(row[columnIndex.vlrDesdobramento] || '0');
                const vlrJuros = parseNumber(row[columnIndex.vlrJuros] || '0');
                
                // Determinar o m√™s/ano do pagamento
                let mesAno = 'Desconhecido';
                if (dataBaixa) {
                    const dataBaixaObj = parseExcelDate(dataBaixa);
                    if (dataBaixaObj && !isNaN(dataBaixaObj.getTime())) {
                        const mes = dataBaixaObj.getMonth() + 1;
                        const ano = dataBaixaObj.getFullYear();
                        mesAno = `${mes}/${ano}`;
                    } else if (dtVencimento) {
                        const vencimentoObj = parseExcelDate(dtVencimento);
                        if (vencimentoObj && !isNaN(vencimentoObj.getTime())) {
                            const mes = vencimentoObj.getMonth() + 1;
                            const ano = vencimentoObj.getFullYear();
                            mesAno = `${mes}/${ano}`;
                        }
                    }
                }
                
                // Calcular valor l√≠quido
                const valorLiquido = vlrBaixa - vlrJuros;
                
                // Calcular dias em atraso
                let diasAtraso = 0;
                if (dtVencimento && dataBaixa) {
                    const vencDate = parseExcelDate(dtVencimento);
                    const baixaDate = parseExcelDate(dataBaixa);
                    
                    if (vencDate && baixaDate) {
                        diasAtraso = Math.floor((baixaDate - vencDate) / (1000 * 60 * 60 * 24));
                    }
                }
                
                // Categorizar o pagamento
                const categoria = categorizarPagamentoComTolerancia(diasAtraso, tolerancia);
                
                const pagamento = {
                    nome: nomeParceiro,
                    nomeFantasia: nomeFantasia,
                    apelido: apelido,
                    descricao: descricao,
                    nroNota: nroNota,
                    valorDesdobramento: vlrDesdobramento,
                    valorJuros: vlrJuros,
                    valorBaixa: vlrBaixa,
                    valorLiquido: valorLiquido,
                    vencimento: dtVencimento,
                    dataBaixa: dataBaixa,
                    dataNegociacao: dtNegociacao,
                    nsu: nsu,
                    desdobramento: desdob,
                    historico: historico,
                    diasAtraso: diasAtraso,
                    categoria: categoria,
                    mesAno: mesAno
                };
                
                pagamentos.push(pagamento);
                pagamentosRawData.push(pagamento);
            }
            
            const diasEntreParcelas = parseInt(document.getElementById('diasEntreParcelas').value) || 30;
            const resultadoDetecao = detectarAlteracoesVencimentoAtualizada(pagamentosRawData, diasEntreParcelas, tolerancia);
            
            exibirDetecaoAlteracoes(resultadoDetecao);
            
            const pagamentosPorMes = {};
            const categorias = [
                'Recebidos dentro do prazo',
                'Recebidos de 01 √† 15 dias',
                'Recebidos de 16 √† 30 dias',
                'Recebidos de 31 √† 90 dias',
                'Recebidos acima 91 dias'
            ];
            
            const pagamentosComMesValido = pagamentosRawData.filter(p => p.mesAno !== 'Desconhecido');
            
            pagamentosComMesValido.forEach(p => {
                if (!pagamentosPorMes[p.mesAno]) {
                    pagamentosPorMes[p.mesAno] = {};
                    categorias.forEach(cat => {
                        pagamentosPorMes[p.mesAno][cat] = { quantidade: 0, valor: 0 };
                    });
                }
                
                pagamentosPorMes[p.mesAno][p.categoria].quantidade += 1;
                pagamentosPorMes[p.mesAno][p.categoria].valor += p.valorLiquido;
            });
            
            pagamentosProcessados = pagamentosPorMes;
            
            parcelasMonitoradas = resultadoDetecao.alteracoes;
            dadosDedupFiltrados = deduplicarDados(pagamentosRawData);
            
            atualizarListaParcelasVisualMultiplo(Array.from(filtrosSelecionados));
            atualizarTabelaPagamentosMultiplos();
            
            showResultsPanel(pagamentos);
            saveDataToLocalStorage();
            
            alert(`Planilha processada com sucesso!\n\n‚Ä¢ ${pagamentos.length} registros processados\n‚Ä¢ ${resultadoDetecao.totalAlteracoes} parcelas com poss√≠vel altera√ß√£o\n‚Ä¢ ${Object.keys(pagamentosPorMes).length} meses identificados`);
        }

        function detectarAlteracoesVencimentoAtualizada(pagamentos, diasEntreParcelas = 30, toleranciaDias = 2) {
            const alteracoes = [];
            const clientesMap = new Map();
            
            // Organizar pagamentos por cliente
            pagamentos.forEach(pagamento => {
                const clienteNome = pagamento.nome || pagamento.apelido || pagamento.nomeFantasia || '';
                if (!clienteNome) return;
                
                if (!clientesMap.has(clienteNome)) {
                    clientesMap.set(clienteNome, []);
                }
                clientesMap.get(clienteNome).push(pagamento);
            });
            
            clientesMap.forEach((pagamentosCliente, clienteNome) => {
                const pagamentosAgrupados = [];
                const grupos = [];
                
                // Agrupar por n√∫mero de parcela (baseado em descri√ß√£o ou desdobramento)
                pagamentosCliente.forEach(pagamento => {
                    const descricao = pagamento.descricao || pagamento.historico || '';
                    const desdobramento = pagamento.desdobramento || '';
                    
                    // Tentar extrair n√∫mero da parcela
                    let numeroParcela = 1;
                    let totalParcelas = 1;
                    
                    // Tentar encontrar padr√£o como "PARCELA 1/12" ou "1/12"
                    const padraoParcela = /(\d+)\s*\/\s*(\d+)/i;
                    const match = descricao.match(padraoParcela) || desdobramento.match(padraoParcela);
                    
                    if (match) {
                        numeroParcela = parseInt(match[1]);
                        totalParcelas = parseInt(match[2]);
                    } else {
                        // Tentar encontrar apenas n√∫mero
                        const padraoNumero = /parcela\s*(\d+)/i;
                        const matchNumero = descricao.match(padraoNumero) || desdobramento.match(padraoNumero);
                        if (matchNumero) {
                            numeroParcela = parseInt(matchNumero[1]);
                        }
                    }
                    
                    const pagamentoInfo = {
                        ...pagamento,
                        numeroParcela,
                        totalParcelas,
                        dataBase: pagamento.dataNegociacao || null
                    };
                    
                    pagamentosAgrupados.push(pagamentoInfo);
                });
                
                // Ordenar por n√∫mero de parcela
                pagamentosAgrupados.sort((a, b) => a.numeroParcela - b.numeroParcela);
                
                // Processar cada pagamento para detectar altera√ß√µes
                pagamentosAgrupados.forEach(pagamento => {
                    const vencimentoReal = pagamento.vencimento;
                    const dataBase = pagamento.dataBase || pagamento.dataBaixa;
                    
                    if (!vencimentoReal || !dataBase) return;
                    
                    const vencimentoRealDate = parseExcelDate(vencimentoReal);
                    const dataBaseDate = parseExcelDate(dataBase);
                    
                    if (!vencimentoRealDate || !dataBaseDate) return;
                    
                    let vencimentoEstimadoDate = null;
                    let metodoCalculo = 'Desconhecido';
                    
                    // Tentar calcular vencimento estimado baseado na data base
                    if (pagamento.numeroParcela && pagamento.totalParcelas) {
                        vencimentoEstimadoDate = calcularDataPorTotalParcelas(
                            dataBase, 
                            pagamento.numeroParcela, 
                            pagamento.totalParcelas, 
                            diasEntreParcelas
                        );
                        metodoCalculo = `Parcela ${pagamento.numeroParcela}/${pagamento.totalParcelas}`;
                    } else if (pagamento.numeroParcela) {
                        vencimentoEstimadoDate = calcularDataPorNumeroParcela(
                            dataBase, 
                            pagamento.numeroParcela, 
                            diasEntreParcelas
                        );
                        metodoCalculo = `Parcela ${pagamento.numeroParcela}`;
                    }
                    
                    if (!vencimentoEstimadoDate) return;
                    
                    // Calcular diferen√ßa em dias
                    const diferencaDias = Math.floor((vencimentoRealDate - vencimentoEstimadoDate) / (1000 * 60 * 60 * 24));
                    
                    // Determinar probabilidade
                    let probabilidade = 'baixa';
                    if (diferencaDias > 7) {
                        probabilidade = 'alta';
                    } else if (diferencaDias >= 3 && diferencaDias <= 7) {
                        probabilidade = 'media';
                    } else {
                        probabilidade = 'baixa';
                    }
                    
                    // Determinar status de pagamento
                    let statusPagamento = 'N√£o classificado';
                    const dataBaixaDate = parseExcelDate(pagamento.dataBaixa);
                    
                    if (dataBaixaDate) {
                        const diasAtrasoPagamento = Math.floor((dataBaixaDate - vencimentoRealDate) / (1000 * 60 * 60 * 24));
                        
                        if (diasAtrasoPagamento > toleranciaDias) {
                            statusPagamento = 'Pago em atraso';
                        } else {
                            statusPagamento = 'Dentro do prazo';
                        }
                    } else {
                        statusPagamento = 'N√£o pago';
                    }
                    
                    // Calcular valor total de parcelas (estimativa)
                    let valorTotalEstimado = 0;
                    if (pagamento.valorLiquido && pagamento.totalParcelas && pagamento.numeroParcela) {
                        valorTotalEstimado = pagamento.valorLiquido * pagamento.totalParcelas;
                    } else {
                        valorTotalEstimado = pagamento.valorLiquido || 0;
                    }
                    
                    const alteracao = {
                        cliente: clienteNome,
                        parcela: pagamento.numeroParcela,
                        totalParcelas: pagamento.totalParcelas,
                        vencimentoEstimado: formatDateBR(vencimentoEstimadoDate),
                        vencimentoReal: formatDateBR(vencimentoRealDate),
                        dataBaixa: formatDateBR(pagamento.dataBaixa),
                        diferencaDias: diferencaDias,
                        probabilidade: probabilidade,
                        statusPagamento: statusPagamento,
                        metodoCalculo: metodoCalculo,
                        valor: pagamento.valorLiquido,
                        valorTotalEstimado: valorTotalEstimado,
                        nota: pagamento.nroNota,
                        descricao: pagamento.descricao,
                        historico: pagamento.historico
                    };
                    
                    alteracoes.push(alteracao);
                });
            });
            
            const clientesAfetados = new Set(alteracoes.map(a => a.cliente)).size;
            const mediaDiferenca = alteracoes.length > 0 
                ? alteracoes.reduce((sum, a) => sum + Math.abs(a.diferencaDias), 0) / alteracoes.length 
                : 0;
            
            return {
                totalAlteracoes: alteracoes.length,
                mediaDiferenca: mediaDiferenca.toFixed(2),
                clientesAfetados: clientesAfetados,
                alteracoes: alteracoes
            };
        }

        function verDetalhesParcela(index) {
            if (index < 0 || index >= parcelasMonitoradas.length) {
                console.error('√çndice de parcela inv√°lido:', index);
                return;
            }
            
            const parcela = parcelasMonitoradas[index];
            
            const modalConteudo = document.getElementById('modalDetalhesConteudo');
            const modalInterpretacao = document.getElementById('modalInterpretacao');
            
            const conteudoHTML = `
                <div class="modal-grid">
                    <div class="modal-item">
                        <div class="modal-label">Cliente</div>
                        <div class="modal-valor">${parcela.cliente}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Parcela</div>
                        <div class="modal-valor">${parcela.parcela}/${parcela.totalParcelas}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Vencimento Estimado</div>
                        <div class="modal-valor">${parcela.vencimentoEstimado}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Vencimento Real</div>
                        <div class="modal-valor">${parcela.vencimentoReal}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Data da Baixa</div>
                        <div class="modal-valor">${parcela.dataBaixa}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Diferen√ßa (dias)</div>
                        <div class="modal-valor ${parcela.diferencaDias > 0 ? 'diferenca-negativa' : 'diferenca-positiva'}">
                            ${parcela.diferencaDias > 0 ? '+' : ''}${parcela.diferencaDias} dias
                        </div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Probabilidade</div>
                        <div class="modal-valor">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${
                                parcela.probabilidade === 'alta' ? 'bg-red-500' :
                                parcela.probabilidade === 'media' ? 'bg-yellow-500' : 'bg-blue-500'
                            }">
                                ${parcela.probabilidade.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Status do Pagamento</div>
                        <div class="modal-valor">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${
                                parcela.statusPagamento === 'Pago em atraso' ? 'bg-red-500' :
                                parcela.statusPagamento === 'Dentro do prazo' ? 'bg-green-500' : 'bg-yellow-500'
                            }">
                                ${parcela.statusPagamento}
                            </span>
                        </div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Valor</div>
                        <div class="modal-valor">R$ ${formatBrazilianNumber(parcela.valor)}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">Valor Total Estimado</div>
                        <div class="modal-valor">R$ ${formatBrazilianNumber(parcela.valorTotalEstimado)}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">N√∫mero da Nota</div>
                        <div class="modal-valor">${parcela.nota || 'N/A'}</div>
                    </div>
                    <div class="modal-item">
                        <div class="modal-label">M√©todo de C√°lculo</div>
                        <div class="modal-valor">${parcela.metodoCalculo}</div>
                    </div>
                </div>
            `;
            
            let interpretacaoHTML = '';
            if (parcela.diferencaDias > 0) {
                interpretacaoHTML = `
                    <div class="modal-interpretacao-titulo">üìä An√°lise da Parcela</div>
                    <div class="modal-interpretacao-texto">
                        <strong>Poss√≠vel altera√ß√£o identificada:</strong> O vencimento real (${parcela.vencimentoReal}) est√° <strong>${Math.abs(parcela.diferencaDias)} dias ${parcela.diferencaDias > 0 ? 'ap√≥s' : 'antes'}</strong> da data estimada (${parcela.vencimentoEstimado}).
                        <br><br>
                        <strong>Probabilidade ${parcela.probabilidade.toUpperCase()}:</strong>
                        ${parcela.probabilidade === 'alta' ? 'Alta probabilidade de altera√ß√£o de prazo (> 7 dias).' : 
                          parcela.probabilidade === 'media' ? 'M√©dia probabilidade de altera√ß√£o (3-7 dias).' : 
                          'Baixa probabilidade de altera√ß√£o (1-2 dias ou negativa).'}
                        <br><br>
                        <strong>Status:</strong> ${parcela.statusPagamento === 'Pago em atraso' ? 'Pagamento realizado fora do prazo estabelecido.' : 
                          parcela.statusPagamento === 'Dentro do prazo' ? 'Pagamento realizado dentro do prazo com toler√¢ncia.' : 
                          'Status de pagamento n√£o classificado.'}
                        <br><br>
                        <strong>A√ß√£o recomendada:</strong> ${parcela.diferencaDias > 7 ? 'Verificar com o cliente se houve renegocia√ß√£o do prazo.' : 
                          parcela.diferencaDias > 0 ? 'Monitorar pr√≥ximas parcelas para identificar padr√£o.' : 
                          'Situa√ß√£o dentro do esperado.'}
                    </div>
                `;
            } else {
                interpretacaoHTML = `
                    <div class="modal-interpretacao-titulo">üìä An√°lise da Parcela</div>
                    <div class="modal-interpretacao-texto">
                        <strong>Situa√ß√£o normal:</strong> O vencimento real (${parcela.vencimentoReal}) est√° <strong>${Math.abs(parcela.diferencaDias)} dias ${parcela.diferencaDias > 0 ? 'ap√≥s' : 'antes'}</strong> da data estimada (${parcela.vencimentoEstimado}).
                        <br><br>
                        <strong>Probabilidade ${parcela.probabilidade.toUpperCase()}:</strong> ${parcela.probabilidade === 'baixa' ? 'Baixa probabilidade de altera√ß√£o, situa√ß√£o normal.' : 'Situa√ß√£o dentro dos par√¢metros esperados.'}
                        <br><br>
                        <strong>Status:</strong> ${parcela.statusPagamento === 'Pago em atraso' ? 'Pagamento realizado com atraso. Verificar necessidade de a√ß√£o.' : 
                          parcela.statusPagamento === 'Dentro do prazo' ? 'Pagamento realizado dentro do prazo estabelecido.' : 
                          'Aguardando pagamento.'}
                        <br><br>
                        <strong>Recomenda√ß√£o:</strong> Continuar monitoramento normal.
                    </div>
                `;
            }
            
            modalConteudo.innerHTML = conteudoHTML;
            modalInterpretacao.innerHTML = interpretacaoHTML;
            
            document.getElementById('modalDetalhesParcela').classList.add('active');
            document.querySelector('.modal-titulo').textContent = 'üìã Detalhes da Parcela';
        }

        function fecharModalDetalhes() {
            document.getElementById('modalDetalhesParcela').classList.remove('active');
        }

        function processarDadosAtrasados(data, columnMap) {
            const headers = data[0];
            const columnIndex = {};
            
            function columnLetterToIndex(letter) {
                let column = 0;
                letter = letter.toUpperCase().trim();
                for (let i = 0; i < letter.length; i++) {
                    column = column * 26 + (letter.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
                }
                return column - 1;
            }
            
            function normalizeColumnName(name) {
                if (!name) return '';
                return name.toString().trim().toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, ' ')
                    .replace(/[^\w\s]/gi, '');
            }
            
            for (let key in columnMap) {
                const columnSpec = columnMap[key].toString().trim();
                let index = -1;
                
                if (!columnSpec) {
                    columnIndex[key] = -1;
                    continue;
                }
                
                if (/^[A-Z]+$/i.test(columnSpec)) {
                    index = columnLetterToIndex(columnSpec);
                } 
                else if (/^\d+$/.test(columnSpec)) {
                    index = parseInt(columnSpec) - 1;
                }
                else {
                    const normalizedSpec = normalizeColumnName(columnSpec);
                    for (let i = 0; i < headers.length; i++) {
                        if (headers[i]) {
                            const normalizedHeader = normalizeColumnName(headers[i]);
                            if (normalizedHeader === normalizedSpec) {
                                index = i;
                                break;
                            }
                        }
                    }
                    
                    if (index === -1) {
                        for (let i = 0; i < headers.length; i++) {
                            if (headers[i]) {
                                const normalizedHeader = normalizeColumnName(headers[i]);
                                if (normalizedHeader.includes(normalizedSpec) || normalizedSpec.includes(normalizedHeader)) {
                                    index = i;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                columnIndex[key] = index;
            }
            
            const colunasRequisitadas = ['parceiro', 'valor', 'dataVencimento'];
            let colunasFaltantes = [];
            let mensagemErro = '';
            
            for (let coluna of colunasRequisitadas) {
                if (columnIndex[coluna] === undefined || columnIndex[coluna] < 0) {
                    const nomeColuna = columnMap[coluna] || coluna;
                    colunasFaltantes.push(nomeColuna);
                }
            }
            
            if (colunasFaltantes.length > 0) {
                mensagemErro = `As seguintes colunas n√£o foram encontradas: ${colunasFaltantes.join(', ')}\n\n`;
                mensagemErro += `Colunas dispon√≠veis na planilha:\n`;
                
                for (let i = 0; i < headers.length; i++) {
                    const letraColuna = String.fromCharCode(65 + (i % 26)) + (i >= 26 ? String.fromCharCode(64 + Math.floor(i / 26)) : '');
                    const nomeColuna = headers[i] || `(Coluna ${letraColuna} - sem nome)`;
                    mensagemErro += `${letraColuna}: ${nomeColuna}\n`;
                }
                
                alert(mensagemErro);
                return;
            }
            
            const atrasados = [];
            atrasadosProcessados = [];
            estatisticasCobranca = {};
            notasParceirosData = {};
            parcelasAtrasadas = [];
            
            const hoje = new Date();
            const mesExportacao = document.getElementById('atrasadosMesExportacao').value;
            let totalAtrasadosExportacao = 0;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                const parceiro = row[columnIndex.parceiro] ? row[columnIndex.parceiro].toString().trim() : '';
                const valor = parseNumber(row[columnIndex.valor] || '0');
                const dataVencimento = row[columnIndex.dataVencimento] ? row[columnIndex.dataVencimento].toString().trim() : '';
                const nroNota = row[columnIndex.nroNota] ? row[columnIndex.nroNota].toString().trim() : '';
                const cnpjCpf = row[columnIndex.cnpjCpf] ? row[columnIndex.cnpjCpf].toString().trim() : '';
                const natureza = row[columnIndex.natureza] ? row[columnIndex.natureza].toString().trim() : '';
                const tipoNegociacao = row[columnIndex.tipoNegociacao] ? row[columnIndex.tipoNegociacao].toString().trim() : '';
                const observacao = row[columnIndex.observacao] ? row[columnIndex.observacao].toString().trim() : '';
                const diasAtrasoStr = row[columnIndex.diasAtraso] ? row[columnIndex.diasAtraso].toString().trim() : '0';
                
                // Calcular dias em atraso
                let diasAtraso = parseInt(diasAtrasoStr) || 0;
                if (dataVencimento) {
                    const vencDate = parseExcelDate(dataVencimento);
                    if (vencDate) {
                        const diferencaMs = hoje.getTime() - vencDate.getTime();
                        diasAtraso = Math.floor(diferencaMs / (1000 * 60 * 60 * 24));
                        diasAtraso = Math.max(diasAtraso, 0);
                    }
                }
                
                // Determinar status/categoria baseado no tipo de negocia√ß√£o ou observa√ß√£o
                let statusTag = 'EM ATRASO';
                if (tipoNegociacao) {
                    statusTag = tipoNegociacao.toUpperCase();
                } else if (observacao) {
                    const obsUpper = observacao.toUpperCase();
                    if (obsUpper.includes('NOTIFICADO') || obsUpper.includes('NOTIFICA√á√ÉO')) {
                        statusTag = 'NOTIFICADOS';
                    } else if (obsUpper.includes('AJUIZADO') || obsUpper.includes('A√á√ÉO JUDICIAL')) {
                        statusTag = 'AJUIZADOS';
                    } else if (obsUpper.includes('ACORDO') && obsUpper.includes('JUDICIAL')) {
                        statusTag = 'ACORDO - CLIENTE REC. JUDICIAL';
                    } else if (obsUpper.includes('ACORDO') && obsUpper.includes('ASSINADO')) {
                        statusTag = 'ACORDOS ASSINADOS';
                    } else if (obsUpper.includes('PARCEIRO') && obsUpper.includes('ESTRAT√âGICO')) {
                        statusTag = 'PARCEIROS (ESTRAT√âGICOS)';
                    } else if (obsUpper.includes('PRESCRITO') || obsUpper.includes('PRESCRI√á√ÉO')) {
                        statusTag = 'PREESCRITOS';
                    } else if (obsUpper.includes('VALOR') && obsUpper.includes('INFERIOR')) {
                        statusTag = 'VALOR INFERIOR';
                    } else if (obsUpper.includes('NEGOCIA√á√ÉO') || obsUpper.includes('NEGOCIANDO')) {
                        statusTag = 'NEGOCIA√á√ÉO EM ANDAMENTO';
                    } else if (obsUpper.includes('NEGOCIAR')) {
                        statusTag = '√Ä NEGOCIAR';
                    }
                }
                
                // Determinar a data de emiss√£o para c√°lculo de √≠ndices hist√≥ricos
                const dataEmissao = row[columnIndex.dataEmissao] ? row[columnIndex.dataEmissao].toString().trim() : null;
                const anoEmissao = dataEmissao ? (parseExcelDate(dataEmissao)?.getFullYear() || null) : null;
                
                const atrasado = {
                    parceiro: parceiro,
                    nroNota: nroNota,
                    cnpjCpf: cnpjCpf,
                    natureza: natureza,
                    dataVencimento: dataVencimento,
                    dataEmissao: dataEmissao,
                    diasAtraso: diasAtraso,
                    valor: valor,
                    tipoNegociacao: tipoNegociacao,
                    observacao: observacao,
                    statusTag: statusTag,
                    anoEmissao: anoEmissao
                };
                
                atrasados.push(atrasado);
                atrasadosProcessados.push(atrasado);
                
                if (valor > 0) {
                    // Soma para exporta√ß√£o
                    totalAtrasadosExportacao += valor;
                    
                    // Estat√≠sticas de cobran√ßa por status
                    if (!estatisticasCobranca[statusTag]) {
                        estatisticasCobranca[statusTag] = {
                            quantidade: 0,
                            valor: 0
                        };
                    }
                    estatisticasCobranca[statusTag].quantidade++;
                    estatisticasCobranca[statusTag].valor += valor;
                    
                    // Notas e parceiros por ano de emiss√£o
                    if (anoEmissao) {
                        if (!notasParceirosData[anoEmissao]) {
                            notasParceirosData[anoEmissao] = {
                                notas: new Set(),
                                parceiros: new Set()
                            };
                        }
                        
                        if (nroNota) {
                            notasParceirosData[anoEmissao].notas.add(nroNota);
                        }
                        
                        if (parceiro) {
                            notasParceirosData[anoEmissao].parceiros.add(parceiro);
                        }
                    }
                    
                    // Parcelas em atraso para a se√ß√£o de inadimpl√™ncia
                    if (diasAtraso > 0) {
                        parcelasAtrasadas.push(atrasado);
                    }
                }
            }
            
            // Atualizar UI com dados processados
            atualizarEstatisticasCobrancaUI();
            atualizarNotasParceirosUI();
            atualizarAtrasosAnoUI();
            atualizarIndicesHistoricosUI();
            atualizarListaParcelasAtrasadas(parcelasAtrasadas);
            
            // Exportar para tabela de inadimpl√™ncia
            exportarParaInadimplencia(mesExportacao, totalAtrasadosExportacao);
            
            // Atualizar gr√°ficos relacionados
            updateNotasParceirosChart();
            updateAtrasosAnoChart();
            updateCobrancaChart();
            
            saveDataToLocalStorage();
            
            alert(`Planilha de atrasados processada com sucesso!\n\n‚Ä¢ ${atrasados.length} registros processados\n‚Ä¢ ${parcelasAtrasadas.length} parcelas em atraso\n‚Ä¢ Valor total: R$ ${formatBrazilianNumber(totalAtrasadosExportacao)}\n\nDados exportados para o m√™s: ${mesExportacao}`);
        }

        function atualizarEstatisticasCobrancaUI() {
            const tableBody = document.getElementById('cobranca-table-body');
            const statsBody = document.getElementById('estatisticas-cobranca-body');
            
            if (!tableBody && !statsBody) return;
            
            // Ordenar estat√≠sticas por valor (do maior para o menor)
            const estatisticasOrdenadas = Object.entries(estatisticasCobranca)
                .sort(([, a], [, b]) => b.valor - a.valor);
            
            let totalQuantidade = 0;
            let totalValor = 0;
            
            estatisticasOrdenadas.forEach(([categoria, dados]) => {
                totalQuantidade += dados.quantidade;
                totalValor += dados.valor;
            });
            
            // Atualizar tabela da se√ß√£o Configura√ß√µes
            if (tableBody) {
                tableBody.innerHTML = '';
                
                estatisticasOrdenadas.forEach(([categoria, dados]) => {
                    const percent = totalValor > 0 ? (dados.valor / totalValor * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-600';
                    row.innerHTML = `
                        <td class="p-2">${categoria}</td>
                        <td class="p-2 text-right">${dados.quantidade}</td>
                        <td class="p-2 text-right">R$ ${formatBrazilianNumber(dados.valor)}</td>
                        <td class="p-2 text-right">${percent.toFixed(2)}%</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Adicionar linha total
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row border-t-2 border-gray-500 font-bold';
                totalRow.innerHTML = `
                    <td class="p-2">TOTAL INADIMPLENTES</td>
                    <td class="p-2 text-right">${totalQuantidade}</td>
                    <td class="p-2 text-right">R$ ${formatBrazilianNumber(totalValor)}</td>
                    <td class="p-2 text-right">100%</td>
                `;
                tableBody.appendChild(totalRow);
            }
            
            // Atualizar widget de estat√≠sticas
            if (statsBody) {
                statsBody.innerHTML = '';
                
                estatisticasOrdenadas.forEach(([categoria, dados]) => {
                    const percent = totalValor > 0 ? (dados.valor / totalValor * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-600';
                    row.innerHTML = `
                        <td class="p-1 truncate max-w-[100px]" title="${categoria}">${categoria.length > 15 ? categoria.substring(0, 15) + '...' : categoria}</td>
                        <td class="p-1 text-right">${dados.quantidade}</td>
                        <td class="p-1 text-right">R$ ${formatBrazilianNumber(dados.valor)}</td>
                        <td class="p-1 text-right">${percent.toFixed(1)}%</td>
                    `;
                    statsBody.appendChild(row);
                });
                
                // Adicionar linha total
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row border-t-2 border-gray-500 font-bold';
                totalRow.innerHTML = `
                    <td class="p-1">TOTAL</td>
                    <td class="p-1 text-right">${totalQuantidade}</td>
                    <td class="p-1 text-right">R$ ${formatBrazilianNumber(totalValor)}</td>
                    <td class="p-1 text-right">100%</td>
                `;
                statsBody.appendChild(totalRow);
            }
        }

        function atualizarNotasParceirosUI() {
            const tableBody = document.getElementById('notas-parceiros-table-body');
            
            if (!tableBody || !notasParceirosData || Object.keys(notasParceirosData).length === 0) return;
            
            tableBody.innerHTML = '';
            
            // Converter Sets para contagens e ordenar por ano (do mais recente para o mais antigo)
            const anosOrdenados = Object.keys(notasParceirosData)
                .map(ano => parseInt(ano))
                .sort((a, b) => b - a);
            
            anosOrdenados.forEach(ano => {
                const dados = notasParceirosData[ano];
                const notasCount = dados.notas.size;
                const parceirosCount = dados.parceiros.size;
                
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-600';
                row.innerHTML = `
                    <td class="p-2">${ano}</td>
                    <td class="p-2 text-right">${notasCount}</td>
                    <td class="p-2 text-right">${parceirosCount}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function atualizarAtrasosAnoUI() {
            const tableBody = document.getElementById('atrasos-ano-table-body');
            
            if (!tableBody || atrasadosProcessados.length === 0) return;
            
            const atrasosPorAno = {};
            
            atrasadosProcessados.forEach(atrasado => {
                if (atrasado.dataVencimento) {
                    const vencDate = parseExcelDate(atrasado.dataVencimento);
                    if (vencDate) {
                        const ano = vencDate.getFullYear();
                        if (!atrasosPorAno[ano]) {
                            atrasosPorAno[ano] = {
                                valor: 0,
                                quantidade: 0
                            };
                        }
                        atrasosPorAno[ano].valor += atrasado.valor || 0;
                        atrasosPorAno[ano].quantidade += 1;
                    }
                }
            });
            
            // Ordenar por ano (do mais recente para o mais antigo)
            const anosOrdenados = Object.keys(atrasosPorAno)
                .map(ano => parseInt(ano))
                .sort((a, b) => b - a);
            
            tableBody.innerHTML = '';
            
            anosOrdenados.forEach(ano => {
                const dados = atrasosPorAno[ano];
                
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-600';
                row.innerHTML = `
                    <td class="p-2">${ano}</td>
                    <td class="p-2 text-right">R$ ${formatBrazilianNumber(dados.valor)}</td>
                    <td class="p-2 text-right">${dados.quantidade}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function atualizarIndicesHistoricosUI() {
            const tableBody = document.getElementById('historico-table').querySelector('tbody');
            
            if (!tableBody || atrasadosProcessados.length === 0) return;
            
            const indicesHistoricos = {};
            
            atrasadosProcessados.forEach(atrasado => {
                if (atrasado.anoEmissao && atrasado.valor > 0) {
                    const ano = atrasado.anoEmissao;
                    if (!indicesHistoricos[ano]) {
                        indicesHistoricos[ano] = {
                            valorAtrasado: 0,
                            totalContas: 0
                        };
                    }
                    indicesHistoricos[ano].valorAtrasado += atrasado.valor;
                }
            });
            
            // Calcular totais de contas a receber (baseado em dados existentes)
            const anos = Object.keys(indicesHistoricos).map(ano => parseInt(ano)).sort((a, b) => a - b);
            
            // Atualizar linhas da tabela com os dados calculados
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const anoCell = cells[0];
                    const ano = parseInt(anoCell.textContent.trim());
                    
                    if (indicesHistoricos[ano]) {
                        const valorAtrasadoCell = cells[1];
                        const totalContasCell = cells[2];
                        const indiceCell = cells[3];
                        
                        // Manter valores editados pelo usu√°rio se existirem, sen√£o usar valores calculados
                        if (!valorAtrasadoCell.classList.contains('manual-edit')) {
                            valorAtrasadoCell.textContent = formatBrazilianNumber(indicesHistoricos[ano].valorAtrasado);
                        }
                        
                        if (!totalContasCell.classList.contains('manual-edit')) {
                            // Para total de contas, podemos estimar baseado na inadimpl√™ncia atual
                            const totalContas = indicesHistoricos[ano].valorAtrasado / 0.09; // Assume 9% de inadimpl√™ncia
                            totalContasCell.textContent = formatBrazilianNumber(totalContas);
                        }
                        
                        // Recalcular √≠ndice
                        const valorAtrasado = parseNumber(valorAtrasadoCell.textContent);
                        const totalContas = parseNumber(totalContasCell.textContent);
                        const indice = totalContas > 0 ? (valorAtrasado / totalContas * 100) : 0;
                        indiceCell.textContent = indice.toFixed(2) + '%';
                    }
                }
            });
            
            updateHistoricoIndices();
        }

        function exportarParaInadimplencia(mes, valorTotal) {
            const tabelaInadimplencia = document.querySelector('#inadimplencia-table tbody');
            const linhas = tabelaInadimplencia.querySelectorAll('tr');
            
            let encontrou = false;
            let pagamentosForaDoMes = [];
            
            // Verificar se h√° pagamentos de outros meses
            if (atrasadosProcessados.length > 0) {
                const mesesAtual = mes.split('/')[0]; // Extrair apenas o m√™s (ex: "Abril" de "Abril/25")
                
                pagamentosForaDoMes = atrasadosProcessados.filter(atrasado => {
                    if (atrasado.dataVencimento) {
                        const vencDate = parseExcelDate(atrasado.dataVencimento);
                        if (vencDate) {
                            const meses = [
                                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                            ];
                            const mesVencimento = meses[vencDate.getMonth()];
                            return mesVencimento !== mesesAtual;
                        }
                    }
                    return false;
                });
            }
            
            let mensagem = `
                <h3 class="text-lg font-semibold mb-3 text-red-400">üì§ Exportar para Inadimpl√™ncia</h3>
                <p><strong>M√™s selecionado:</strong> ${mes}</p>
                <p><strong>Valor total em atraso:</strong> R$ ${formatBrazilianNumber(valorTotal)}</p>
            `;
            
            if (pagamentosForaDoMes.length > 0) {
                mensagem += `
                    <div class="mt-3 p-3 bg-yellow-900/30 rounded-lg border border-yellow-700">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> ${pagamentosForaDoMes.length} atrasados t√™m vencimento em m√™s diferente de ${mes}
                        <div class="mt-2 text-sm">
                            <strong>Meses de vencimento encontrados:</strong>
                            <ul class="list-disc pl-5 mt-1">
                `;
                
                const mesesFora = {};
                pagamentosForaDoMes.forEach(atrasado => {
                    if (atrasado.dataVencimento) {
                        const vencDate = parseExcelDate(atrasado.dataVencimento);
                        if (vencDate) {
                            const meses = [
                                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                            ];
                            const mesVencimento = meses[vencDate.getMonth()];
                            const anoVencimento = vencDate.getFullYear();
                            const chave = `${mesVencimento}/${anoVencimento}`;
                            
                            if (!mesesFora[chave]) {
                                mesesFora[chave] = {
                                    quantidade: 0,
                                    valor: 0
                                };
                            }
                            mesesFora[chave].quantidade++;
                            mesesFora[chave].valor += atrasado.valor || 0;
                        }
                    }
                });
                
                Object.entries(mesesFora).forEach(([mesFora, dados]) => {
                    mensagem += `
                        <li class="fora-do-mes">
                            ${mesFora}: ${dados.quantidade} atrasados (R$ ${formatBrazilianNumber(dados.valor)})
                        </li>
                    `;
                });
                
                mensagem += `
                            </ul>
                            <p class="mt-2">Considere filtrar a planilha por m√™s antes de exportar se esses atrasados n√£o forem do m√™s ${mes}.</p>
                        </div>
                    </div>
                `;
            }
            
            mensagem += `
                <div class="mt-4">
                    <label class="text-sm text-gray-300 mb-2 block">Selecione a linha para preencher:</label>
                    <select id="select-mes-inadimplencia" class="config-select mb-3">
            `;
            
            linhas.forEach((linha, index) => {
                const celulaMes = linha.querySelector('td:first-child');
                if (celulaMes) {
                    const mesLinha = celulaMes.textContent.trim();
                    mensagem += `<option value="${index}">${mesLinha}</option>`;
                }
            });
            
            mensagem += `
                    </select>
                    <div class="exportar-recuperacao-botoes">
                        <button class="btn-exportar-recuperacao cancelar" onclick="fecharModalDetalhes()">Cancelar</button>
                        <button class="btn-exportar-recuperacao" onclick="preencherValorInadimplencia(${valorTotal})">Preencher Valor</button>
                    </div>
                </div>
            `;
            
            const modalConteudo = document.getElementById('modalDetalhesConteudo');
            const modalInterpretacao = document.getElementById('modalInterpretacao');
            
            modalConteudo.innerHTML = mensagem;
            modalInterpretacao.innerHTML = `
                <div class="modal-interpretacao-titulo">üìã Exporta√ß√£o para √çndice de Inadimpl√™ncia</div>
                <div class="modal-interpretacao-texto">
                    Esta funcionalidade preenche automaticamente o valor total em atraso na tabela "√çndice de Inadimpl√™ncia" na se√ß√£o Configura√ß√µes.
                    <br><br>
                    <strong>Nota:</strong> O valor inclui todos os atrasados da planilha processada.
                    <br><br>
                    <strong>Recomenda√ß√£o:</strong> Para uma an√°lise mais precisa, considere exportar atrasados separadamente por m√™s de vencimento.
                </div>
            `;
            
            document.getElementById('modalDetalhesParcela').classList.add('active');
            document.querySelector('.modal-titulo').textContent = 'üì§ Exportar para Inadimpl√™ncia';
        }

        function preencherValorInadimplencia(valor) {
            const select = document.getElementById('select-mes-inadimplencia');
            const indiceLinha = parseInt(select.value);
            
            const tabelaInadimplencia = document.querySelector('#inadimplencia-table tbody');
            const linhas = tabelaInadimplencia.querySelectorAll('tr');
            
            if (indiceLinha >= 0 && indiceLinha < linhas.length) {
                const linha = linhas[indiceLinha];
                const celulaValor = linha.querySelector('td:nth-child(2)');
                
                if (celulaValor) {
                    celulaValor.textContent = formatBrazilianNumber(valor);
                    celulaValor.classList.add('manual-edit');
                    
                    const event = new Event('blur');
                    celulaValor.dispatchEvent(event);
                    
                    fecharModalDetalhes();
                    alert(`Valor de R$ ${formatBrazilianNumber(valor)} preenchido com sucesso!`);
                    
                    setTimeout(() => {
                        showSection('configuracoes');
                        const tabela = document.querySelector('#inadimplencia-table');
                        if (tabela) {
                            tabela.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 500);
                }
            }
        }

        // ========== FUN√á√ïES DE NAVEGA√á√ÉO ==========
        function showSection(sectionId) {
            const sections = document.querySelectorAll('[id^="main-section-"], [id$="-section"]');
            
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            let targetSection = null;
            switch(sectionId) {
                case 'inicio':
                    targetSection = document.getElementById('main-section-inicio');
                    break;
                case 'inadimplencia':
                    targetSection = document.getElementById('main-section-inadimplencia');
                    break;
                case 'recuperacao':
                    targetSection = document.getElementById('recuperacao-section');
                    break;
                case 'credtime':
                    targetSection = document.getElementById('credtime-section');
                    break;
                case 'planilhas':
                    targetSection = document.getElementById('planilhas-section');
                    break;
                case 'configuracoes':
                    targetSection = document.getElementById('configuracoes-section');
                    break;
                case 'renegociar':
                    targetSection = document.getElementById('renegociar-section');
                    break;
            }
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
                
                if (sectionId === 'renegociar') {
                    initRenegociarTable();
                    initSelectionTools();
                }
                
                setTimeout(() => {
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function initializeDashboard() {
            loadDataFromLocalStorage();
            
            showSection('inicio');
            initRenegociarTable();
            initSelectionTools();
            
            setTimeout(() => {
                initializeAllCharts();
            }, 500);
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar eventos de c√©lula edit√°vel
            document.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('blur', function() {
                    handleManualEdit(this);
                    saveDataToLocalStorage();
                    
                    // Verificar se √© uma c√©lula que atualiza gr√°ficos
                    if (this.classList.contains('update-inadimplencia')) {
                        updateInadimplenciaCharts();
                    } else if (this.classList.contains('update-recuperacao')) {
                        updateRecuperacaoCharts();
                    } else if (this.classList.contains('update-analise-credito')) {
                        updateAnaliseCreditoCharts();
                    } else if (this.classList.contains('update-prazo-medio')) {
                        updatePrazoMedioChart();
                    } else if (this.classList.contains('update-historico')) {
                        updateHistoricoIndices();
                    } else if (this.classList.contains('update-reneg-detalhado')) {
                        updateDetailedReneg(this);
                    }
                });
            });
            
            // Configurar eventos de input de desconto
            const discountInput = document.getElementById('discount-input');
            if (discountInput) {
                discountInput.addEventListener('input', function() {
                    updateDetailedStatistics();
                    saveDataToLocalStorage();
                });
            }
            
            // Inicializar filtros
            filtrosSelecionados.add('todas');
            filtrosAtrasadosSelecionados.add('todos');
            atualizarBadgesFiltros();
            atualizarBadgesFiltrosAtrasados();
            
            // Carregar dados salvos
            loadDataFromLocalStorage();
        });

    </script>
</body>
</html>